<!DOCTYPE html> <html class=no-js lang=en> <head> <meta charset=utf-8> <meta content='width=device-width, initial-scale=1.0' name=viewport> <meta content='IE=edge,chrome=1' http-equiv=X-UA-Compatible> <title>Brain Matters</title> <link href="/assets/stylesheets/app-081615f0.css" rel=stylesheet /> <script src="/assets/javascripts/modernizr-84a49412.js"></script> <link href='/assets/images/wb-square-e5e8663b.png' rel=icon sizes=128x128 type='image/png'> </head> <body class='blog blog_page blog_page_23 blog_page_23_index f-topbar-fixed'> <div class='fixed raised'> <nav class=top-bar data-topbar role=navigation> <ul class=title-area> <li class=name> <h1> <a href='/'> <img alt=Agora class="wb-agora main-logo" src="/assets/images/wb-agora-b60168ae.svg"/> </a> </h1> </li> <li class='toggle-topbar menu-icon'> <a href='javascript:void(0)'> <span>Menu</span> </a> </li> </ul> <section class=top-bar-section> <ul class=right> <li> <a data-anchor href='/#about'>About</a> </li> <li> <a data-anchor href='/#team'>Team</a> </li> <li> <a href='/careers'>Careers</a> </li> <li> <a data-anchor href='/#contact'>Contact</a> </li> <li class=hydra-theme> <a href='http://hydra.agoragames.com'> <img alt=Hydra width=92 src="/assets/images/hydra-wordmark-6248cf07.svg"/> </a> </li> </ul> </section> </nav> </div> <div class=row> <div class=columns> <h1 class=blog-page-title> <a href="/blog">The <strong>Blog</strong> </a></h1> </div> </div> <div class=row> <div class='columns large-9'> <div class=blog-entry-list><div class=blog-entry> <div class=blog__date> Apr 9 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/04/09/as-it-turns-out-faking-it-is-ok/">As It Turns Out, Faking It Is OK</a> </h2> <div class=blog__author> By <strong>David Czarnecki</strong> </div> <div class=blog__body> <p>This post is totally SFW. That&rsquo;s all your going to get in this teaser.</p> <p><img title=when_harry_met_sally alt=when_harry_met_sally width=334 height=286 src="/assets/images/uploads/2010/04/themarketingblog_e_a001438922.JPG"/></p> <p>I just inherited an application and was adding some tests and noticed that one of the tests was randomly failing. As I dug in more, this particular controller test, in executing the controller&rsquo;s index method, was actually calling out on the intertubes to request some data. For an integration test that&rsquo;s probably OK, but my view is that unit and functional tests should be self-contained.</p> <p>Enter <a href="http://github.com/chrisk/fakeweb">Fakeweb</a>.</p> <p>&ldquo;FakeWeb is a helper for faking web requests in Ruby. It works at a global level, without modifying code or writing extensive stubs.&rdquo;</p> <p>3 lines of code later and I have a self-contained functional test that works with real data.</p> <pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">setup</span>
  <span class="no">FakeWeb</span><span class="p">.</span><span class="nf">allow_net_connect</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">teardown</span>
  <span class="no">FakeWeb</span><span class="p">.</span><span class="nf">allow_net_connect</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="nb">test</span> <span class="s2">"should get index"</span> <span class="k">do</span>
  <span class="no">FakeWeb</span><span class="p">.</span><span class="nf">register_uri</span><span class="p">(</span><span class="ss">:get</span><span class="p">,</span> <span class="s1">'http://my.real.url.on.the.internets.com'</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">),</span> <span class="s1">'../fakeweb'</span><span class="p">,</span> <span class="s1">'some-file.xml'</span><span class="p">),</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="s2">"text/xml"</span><span class="p">)</span>

  <span class="n">get</span> <span class="ss">:index</span>
  <span class="n">assert_response</span> <span class="ss">:success</span>

 <span class="p">.</span><span class="nf">.</span><span class="o">.</span>

</code></pre> <p>All I needed to do was simply register the URI that was being referenced in my test, provide a valid (or invalid depending on the test) response, and my test will never try to access the real internet.</p> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Apr 7 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/04/07/the-importance-of-having-a-fast-test-suite/">The Importance of Having a (Fast) Test Suite</a> </h2> <div class=blog__author> By <strong>David Czarnecki</strong> </div> <div class=blog__body> <p>Speed is the name of the game. Or is it?</p> <p>I was adding another project to our Continuous Integration (CI) server that runs the test suite for a project after code is checked in and started noticing the time it takes to build certain projects. A few interesting statistics for you to noodle on.</p> <p>Average build time: ~32 seconds</p> <p>Max build time: 1 hour and 48 minutes</p> <p>There are approximately 18 projects that get built through CI and many other projects that have not been setup for CI.</p> <p>What does this tell us? Testing is not an impediment to development because it takes too long to run tests. As most test suites run in less than a minute, not running the test suite is not an option for our developers. And if you don&rsquo;t, CI sends an e-mail to the team letting everyone know you broke the build. And since our post-commit hooks for SVN and git notify our Campfire room each time code is committed, chances are you&rsquo;re going to get an earful in Campfire telling you to fix the build because your last commit broke the build.</p> <p><img title=chet_weird_science alt=chet_weird_science width=495 height=264 src="/assets/images/uploads/2010/04/Picture-17-cb856a7c.png"/></p> <p>I&rsquo;m glad nearly all of our projects have test suites that run quickly, but I also have a practical view on test suites. <strong>Above all, if nothing else, I want a test suite to exist.</strong> I want it to be there so that when I&rsquo;m adding code to the repository, the test suite is looking at me asking for more.</p> <p><img title="More tests please!" alt="More tests please!" width=188 height=203 src="/assets/images/uploads/2010/04/Picture-16-f97d6155.png"/></p> <p>About that project that takes 1 hour and 48 minutes to build? Right. Guitar Hero. It&rsquo;s a BIG project. It&rsquo;s over 3 years old. There is a LOT of code. We test A LOT of systems, e.g. accounts, clans, tournaments, leaderboards, game configurations, game integration processing, etc. I&rsquo;m OK with it taking that long to run the test suite. We have development practices that we follow for running sub-sections of the test suite when we touch the application to test our new code.</p> <p>To summarize:</p> <ul> <li>Ensure your projects have a test suite</li> <li>Run a Continuous Integration (CI) server for your projects for when developers forget to run the test suite before committing code</li> <li>Ensure your projects have a test suite</li> <li>Ensure your projects have a test suite</li> <li>Ensure your projects have a test suite</li> <li>Make sure developers know how to run part of the test suite for long-running test suites</li> <li>Ensure your projects have a test suite</li> </ul> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Mar 30 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/03/30/all-parsers-are-not-created-equal/">All Parsers Are Not Created Equal</a> </h2> <div class=blog__author> By <strong>David Czarnecki</strong> </div> <div class=blog__body> <p>This is a post about <a href="http://en.wikipedia.org/wiki/Xml">XML</a> and <a href="http://en.wikipedia.org/wiki/JSON">JSON</a>.</p> <p>We recently came across a bottleneck in one of our applications that grabs data from a content repository. A large part of the bottleneck had to do with caching of data from the content repository, or lack thereof. A small part of the bottleneck has to do with parsing of XML data as the application grabs XML feeds from the content repository and parses it to display data within the application. Novel idea using XML as a communication mechanism between 2 applications? You betcha.</p> <p>In any event, boring machine name aside, I decided to benchmark the data parsing via JSON, Hpricot, and Simple-RSS.</p> <pre class="highlight ruby"><code><span class="no">David</span><span class="o">-</span><span class="no">Czarneckis</span><span class="o">-</span><span class="n">iMac</span><span class="ss">:application</span><span class="o">-</span><span class="n">playground</span> <span class="n">dczarnecki</span><span class="err">$</span> <span class="n">ruby</span> <span class="n">parsing</span><span class="o">-</span><span class="n">benchmarking</span><span class="p">.</span><span class="nf">rb</span>
<span class="s2">"Benchmarking JSON"</span>
<span class="s2">"    JSON document: /Users/dczarnecki/projects/parsing-benchmarking/sample_json_document.json, Size: 161574"</span>
<span class="s2">"    JSON::Ext::ParserJSON::Ext::Generator"</span>
<span class="s2">"    Benchmarked JSON parse for 20x (average): 0.0121459603309631"</span>
<span class="s2">"Benchmarking Hpricot"</span>
<span class="s2">"    XML document: /Users/dczarnecki/projects/parsing-benchmarking/sample_photo_rss_document.rss, Size: 162644"</span>
<span class="s2">"    Benchmarked XML parse for 20x (average): 0.00232400894165039"</span>
<span class="s2">"Benchmarking Simple-RSS"</span>
<span class="s2">"    XML document: /Users/dczarnecki/projects/parsing-benchmarking/sample_photo_rss_document.rss, Size: 162644"</span>
<span class="s2">"    Benchmarked XML parse for 20x (average): 1.78787769079208"</span>
<span class="no">David</span><span class="o">-</span><span class="no">Czarneckis</span><span class="o">-</span><span class="n">iMac</span><span class="ss">:application</span><span class="o">-</span><span class="n">playground</span> <span class="n">dczarnecki</span><span class="err">$</span>
</code></pre> <p>The numbers are interesting. Here is my opinion on the results:</p> <ul> <li><p>Hpricot is the fastest at parsing a big XML document. You have to use XPath to get at the elements in the document. XPath is, for me, non-intuitive and you sacrifice a bit in terms of readability of the code.</p></li> <li><p>JSON is the second fastest at parsing a big JSON document. Also, you have a four letter acronym technology integrated into your application, and let&rsquo;s finally admit it, size matters. For me, you gain intuitive access to the underlying data and more readability of the code.</p></li> <li><p>Simple-RSS is slow.</p></li> <li><p>XML output from our content repository doesn&rsquo;t give us paged access to the content, but the JSON API in the content repository does give us paged access to the content. With the XML output, we have to suck down a firehose and slice it up appropriately leading to a bunch of flackery with caching the parsed document.</p></li> </ul> <p>If you&rsquo;re looking for a better read, then check out the following book, &ldquo;Paint It Black: A Guide to Gothic Homemaking&rdquo;.</p> <p><a href="http://www.amazon.com/Paint-Black-Guide-Gothic-Homemaking/dp/1578633613/ref=sr_1_1?ie=UTF8&amp;s=books&amp;qid=1269982528&amp;sr=1-1"><img title="Paint it Black" alt="Paint it Black" width=300 height=300 src="/assets/images/uploads/2010/03/41Jbbh8d2SL._BO2204203200_PIsitb-sticker-arrow-clickTopRight35-76_AA300_SH20_OU01_-3b264d01.jpg"/></a></p> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Mar 11 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/03/11/vbulletin-and-nginx/">vBulletin and NGINX</a> </h2> <div class=blog__author> By <strong>Jason LaPorte</strong> </div> <div class=blog__body> <p>It&rsquo;s no secret that Agorian systems folk favor <a href="http://nginx.org/">NGINX</a> for our web serving needs. We&rsquo;ve written about it a lot before. Therefore, it should be no surprise that we end up making a lot of things designed to work on <a href="http://httpd.apache.org/">Apache</a> work on NGINX. (We&rsquo;ve also written about that before, come to think of it&hellip;)</p> <p>One example is <a href="http://www.vbulletin.com/">vBulletin</a>. A number of Agora&rsquo;s sites are powered by the forum software, which comes with rewriting rules for Apache&rsquo;s <a href="http://httpd.apache.org/docs/2.0/mod/mod_rewrite.html">mod_rewrite</a> and <a href="http://www.iis.net/">IIS</a>&hellip; but not NGINX.</p> <p>So, if you&rsquo;re interested in setting up vBulletin behind NGINX (and are using the advanced URL rewriting, like we are), you can find a sample configuration for doing so  <a href="http://files.agoragames.com/jason/vb-nginx.txt">here</a>.</p> <p>Let us know if you have any questions!</p> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Mar 8 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/03/08/bzr-to-git-migration/">Bzr to Git Migration</a> </h2> <div class=blog__author> By <strong>An Engineer</strong> </div> <div class=blog__body> <p>When I joined Agora, one of the first things I did was talk up <a href="http://git-scm.com">git</a> and how it&rsquo;ll cure cancer, AIDS, and solve world peace. All at once. What that means for me is I&rsquo;ve basically been tasked with the job of migrating anything that&rsquo;s not git to git.</p> <p>For some things these kinds of migration are first class citizens. Conveniently SVN, our old VCS is one of those. One of my new migrations was, less conveniently, <a href="http://bazaar.canonical.com/">Bazaar</a>. Now we have nothing against Bazaar at Agora. I mean my main personal open source project, <a href="http://exaile.org/">Exaile</a>, uses Bazaar. But we agreed we would rather only have one VCS in house.</p> <p>After looking around and trying some fancy tools that didn&rsquo;t work (read: tailor), I stumbled on a really quick solution that seems like it does everything necessary. Both Git and Bazaar (via plugins) support the fast-import/export format. I&rsquo;m not sure about the mystic ways of how this format works but I do know it made my Bazaar repository a Git repository, and that makes me pleased.</p> <h2>Getting the bzr plugin</h2> <p>The first step would be to get the fast-import plugin for Bazaar from the launchpad mirror. <code> mkdir -p ~/.bazaar/plugins cd ~/.bazaar/plugins bzr clone lp:bzr-fastimport fastimport </code> You can make sure it installed properly using a <code>bzr fast-export --help</code> and ensure that it doesn&rsquo;t complain.</p> <h2>Copy the repository</h2> <p>Now that we have all the tools, time to copy it over <code> mkdir ~/project.git cd ~/project.git git init bzr fast-export --plain ~/path/to/bzr/branch | git fast-import git checkout master # only needed for a non-bare repository, like I made above </code></p> <p>Wait a little while (or a long while if you&rsquo;re testing the above code on a netbook for some reason like me). And that should be it.</p> <p>I&rsquo;m not sure how well this works with multiple Bazaar branches. There may be some crazy <code>--flags</code> on each side to make it work but running the code I put above on a full repo makes fast-export complain that I&rsquo;m not pointing it to a valid branch. Please give us your comments if you know how to do this :).</p> <p><strong>Update:</strong> Found out it was .bazaar not .bzr. My bad.</p> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Mar 8 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/03/08/devon-in-print/">Devon in print</a> </h2> <div class=blog__author> By <strong>Devon Smith</strong> </div> <div class=blog__body> <p>Our very own Devon Smith (Agora&rsquo;s multi-talented QA Lead) had an article published in this month&rsquo;s T.E.S.T Magazine. You can see her article online ( <a href="http://www.testmagazine.co.uk/2010/03/keep-the-user-in-mind/">http://www.testmagazine.co.uk/2010/03/keep-the-user-in-mind/</a>), or buy it in print later this month.</p> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Feb 23 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/02/23/experimenting-with-redis/">Experimenting with Redis</a> </h2> <div class=blog__author> By <strong>David Czarnecki</strong> </div> <div class=blog__body> <p>Yesterday I started looking at ways to do inter-application communication. In a number of projects we&rsquo;ve done here at Agora Games, we&rsquo;ve used queues to make that happen. <a href="http://code.google.com/p/redis/">Redis</a> has been on my radar for awhile now, but yesterday I drove my Chevy to the levee and guess what? The levee is NOT dry people. I mean, who drinks rye anyway these days? Old people.</p> <p>Right, <a href="http://code.google.com/p/redis/">Redis</a>.</p> <p>&ldquo;Redis is an advanced key-value store. It is similar to memcached but the dataset is not volatile, and values can be strings, exactly like in memcached, but also lists, sets, and ordered sets. All this data types can be manipulated with atomic operations to push/pop elements, add/remove elements, perform server side union, intersection, difference between sets, and so forth. Redis supports different kind of sorting abilities.&rdquo;</p> <p>I was particularly interested in the support in Redis for lists, which would allow me to have one application push stuff into the datastore and allow for another application to pull stuff from the datastore. A datastore that could operate as a queue? I guess this is as close as we&rsquo;re going to get to flying cars in 2010. Redis is also supposed to be wicked fast and there are a number of libraries available in your programming language of choice with which to communicate with Redis.</p> <p>Redis setup was trivial and &ldquo;just worked&rdquo;.</p> <p>After starting the Redis server, I could just prototype in script/console.</p> <p>Here we go:</p> <pre class="highlight ruby"><code><span class="o">&gt;&gt;</span> <span class="n">redis_queue</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Redis:0x222df9c @thread_safe=nil, @logger=nil, @password=nil, @timeout=5, @db=0, @sock=nil, @host="127.0.0.1", @port=6379&gt;</span>
<span class="o">&gt;&gt;</span> <span class="n">redis_queue</span><span class="p">.</span><span class="nf">push_tail</span> <span class="s1">'strings'</span><span class="p">,</span> <span class="s1">'string 1'</span>
<span class="o">=&gt;</span> <span class="s2">"OK"</span>
<span class="o">&gt;&gt;</span> <span class="n">redis_queue</span><span class="p">.</span><span class="nf">push_tail</span> <span class="s1">'strings'</span><span class="p">,</span> <span class="s1">'string 2'</span>
<span class="o">&gt;&gt;</span> <span class="s2">"OK"</span>
<span class="o">&gt;&gt;</span> <span class="n">redis_queue</span><span class="p">.</span><span class="nf">list_length</span><span class="p">(</span><span class="s1">'strings'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">2</span>
<span class="o">&gt;&gt;</span> <span class="n">redis_queue</span><span class="p">.</span><span class="nf">list_range</span><span class="p">(</span><span class="s1">'strings'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"string 1"</span><span class="p">,</span> <span class="s2">"string 2"</span><span class="p">]</span>
<span class="o">&gt;&gt;</span> <span class="n">some_string</span> <span class="o">=</span> <span class="n">redis_queue</span><span class="p">.</span><span class="nf">pop_head</span><span class="p">(</span><span class="s1">'strings'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"string 1"</span>
<span class="o">&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="nf">list_range</span><span class="p">(</span><span class="s1">'strings'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"string 2"</span><span class="p">]</span>
<span class="o">&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="nf">list_length</span><span class="p">(</span><span class="s1">'strings'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">1</span>
<span class="o">&gt;&gt;</span> <span class="n">quit</span>
</code></pre> <p><a href="http://code.google.com/p/redis/wiki/CommandReference">There are quite a few commands that make Redis even more awesome, but for now I&rsquo;m sold</a>. (If using an entire sentence as a link is wrong then I don&rsquo;t want to be right)</p> <p>Also, I know of <a href="http://github.com/defunkt/resque#readme">Resque</a>, &ldquo;a Redis-backed library for creating background jobs, placing those jobs on multiple queues, and processing them later.&rdquo; If I ever feel like driving the Mercedes Benz of flying cars, I&rsquo;ll use it.</p> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Feb 23 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/02/23/watching-trees/">Watching Trees</a> </h2> <div class=blog__author> By <strong>Jason LaPorte</strong> </div> <div class=blog__body> <p>As a SysAdmin, my job more-or-less exists by knowing miscellaneous arcana that most software engineers aren&rsquo;t aware of.</p> <p>When a particular co-worker here at Agora has a problem with his Linux machine, I provide advice and show him how to fix it. Some months after he had joined Agora, I discovered that after each troubleshooting session, he copy-and-pastes the entire text terminal log into a text file that he keeps on his desktop. He has dozens of transcripts at this point; I bet if I were to look through it, it would read something like the Tao te Ching or Bhagavad Gita, only concerning UNIX instead of right living.</p> <p>(Of course, there&rsquo;s not much of a difference between UNIX and right living, but that&rsquo;s a topic for another day.)</p> <p>In the spirit of allowing you to build your own little collection, here is a simple trick that came in handy to me yesterday.</p> <p>Last night, the cron jobs powering one of our managed sites stopped running. I had stopped them, cleaned up, and restarted them, but I wanted to watch the system and see if they had started running again so I could monitor that they were doing their job.</p> <p>UNIX has a well-known command called &ldquo; <a href="http://linux.die.net/man/1/top">top</a>,&rdquo; which shows superlative processes running on your system: which ones are consuming the most CPU time, which ones are consuming the most RAM, which ones have been running the longest, and so on. It&rsquo;s a very useful tool, but if you&rsquo;re trying to track down processes over time that don&rsquo;t necessarily consume very many resources, then it&rsquo;s not the tool you&rsquo;re looking for.</p> <p>However, our Linux distribution (and, indeed, most others) provide a useful graphical tool for mapping the current state of the system: &ldquo; <a href="http://linux.die.net/man/1/pstree">pstree</a>.&rdquo; This command will give you a list of processes (much like the &ldquo; <a href="http://linux.die.net/man/1/ps">ps</a>&rdquo; command), except that instead of generating a list, it will draw a little tree showing the state of the system. This is perfect for seeing exactly what is going on: which daemons are running, who is on the system and what they&rsquo;re executing, and so on. However, it doesn&rsquo;t show you what is happening over time; it merely lists what is happening at this moment.</p> <p>However, our Linux distribution (and, indeed, most others) provides yet another useful tool: &ldquo; <a href="http://linux.die.net/man/1/watch">watch</a>.&rdquo; It runs a program every 2 seconds (by default) and displays the result to your screen. This allows you to make a ghetto clock by writing something like &ldquo;watch <a href="http://linux.die.net/man/1/date">date</a>;&rdquo; in our case, we could make a ghetto graphical &ldquo;top&rdquo; by writing the simple &ldquo;watch pstree.&rdquo; You can now watch your virtual trees rustle in the wind.</p> <p>It kept us on top of the cron job, and things were back to normal in no time.</p> <p>For more information, RTFM. :)</p> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Feb 22 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/02/22/and-now-for-some-couchdb/">And now for some couchdb</a> </h2> <div class=blog__author> By <strong>Jason LaPorte</strong> </div> <div class=blog__body> <p>I had occasion tonight to give a quick demo of CouchDB.  This is so simple its almost not worth blogging about, but hey, good software is <strong><em>supposed</em></strong> to be simple.</p> <p><strong>Install</strong> On your Mac:</p> <pre class="highlight plaintext"><code> sudo port install couchdb
 sudo launchctl load -w /Library/LaunchDaemons/org.apache.couchdb.plist
</code></pre> <p>On Ubuntu:</p> <pre class="highlight plaintext"><code> sudo apt-get install couchdb
</code></pre> <p>You&rsquo;re done; now to play.</p> <p><strong>Futon Admin Interface</strong> This allows you to create a DB, create records, etc.</p> <ol> <li>Open http://localhost:5984/_utils/</li> <li>&hellip;</li> <li>Prosper</li> </ol> <p><strong>Using our old friend <em>curl</em></strong></p> <pre class="highlight plaintext"><code> curl -X PUT http://localhost:5984/mlg/ #create a db
 curl -X GET http://localhost:5984/mlg/ #get a whole bunch of info about the db
 curl -X POST http://localhost:5984/mlg/ -H "Content-Type:application/json" -d '{"body": "Here is a paragraph"}' #create a record
</code></pre> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Jan 29 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/01/29/getting-started-with-data_fabric/">Getting started with data_fabric</a> </h2> <div class=blog__author> By <strong>David Czarnecki</strong> </div> <div class=blog__body> <p>The <a href="http://github.com/mperham/data_fabric">data_fabric</a> gem &ldquo;provides flexible database connection switching for ActiveRecord&rdquo;. If you&rsquo;re not concerned with database sharding, you might want to skip this blog post. Or not. Either way, I&rsquo;m not going to be offended.</p> <p>I have a requirement that certain data in an application that I&rsquo;m developing will probably have to be sharded because, if you&rsquo;ll excuse my English, there will a &ldquo;shit ton&rdquo; of data. This only affects one model out of the few models I have in the application. I don&rsquo;t have a requirement that the data will be replicated (which is another feature supported in <code>data_fabric</code>), so I&rsquo;m not going into that here. In any event, here is a rundown of how I got started developing and testing with <code>data_fabric</code>.</p> <ul> <li>Configure the <code>data_fabric</code> gem in your <code>config/environment.rb</code> file.</li> </ul> <pre class="highlight ruby"><code><span class="n">config</span><span class="p">.</span><span class="nf">gem</span> <span class="s1">'data_fabric'</span>
</code></pre> <ul> <li>In your model(s), decide on which column or how the data is going to be shared.</li> </ul> <pre class="highlight ruby"><code><span class="n">data_fabric</span> <span class="ss">:replicated</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:shard_by</span> <span class="o">=&gt;</span> <span class="ss">:initial_code</span>
</code></pre> <p>In this case, inital_code is a method that looks at a piece of the model&rsquo;s data and gives me the correct shard.</p> <ul> <li>Setup the database shards in your <code>config/database.yml</code> file. I actually setup only one shard for development and testing environments to make things easier. I&rsquo;m just including the one for the test environment here. You can read on the <code>data_fabric</code> site about the naming convention for sharded database connections.</li> </ul> <pre class="highlight yaml"><code><span class="s">test</span><span class="pi">:</span>
<span class="s">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="s">encoding</span><span class="pi">:</span> <span class="s">utf8</span>
<span class="s">reconnect</span><span class="pi">:</span> <span class="s">false</span>
<span class="s">database</span><span class="pi">:</span> <span class="s">myapp_test</span>
<span class="s">pool</span><span class="pi">:</span> <span class="s">5</span>
<span class="s">username</span><span class="pi">:</span> <span class="s">root</span>
<span class="s">password</span><span class="pi">:</span>

<span class="c1"># This is the database shard</span>
<span class="s">initial_code_testenv_test</span><span class="pi">:</span>
<span class="s">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="s">encoding</span><span class="pi">:</span> <span class="s">utf8</span>
<span class="s">reconnect</span><span class="pi">:</span> <span class="s">false</span>
<span class="s">database</span><span class="pi">:</span> <span class="s">myapp_test_testenv</span>
<span class="s">pool</span><span class="pi">:</span> <span class="s">5</span>
<span class="s">username</span><span class="pi">:</span> <span class="s">root</span>
<span class="s">password</span><span class="pi">:</span>
</code></pre> <ul> <li>In <code>config/initializers/my_app_model.rb</code>, I actually stub out the initial_code method to return a single value for the development and test environments. This is merely convenience so I don&rsquo;t have to include every single database shard for development and testing.</li> </ul> <pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'mocha'</span>

<span class="k">if</span> <span class="s1">'development'</span><span class="p">.</span><span class="nf">eql?</span><span class="p">(</span><span class="no">RAILS_ENV</span><span class="p">)</span>
  <span class="no">PromotionCode</span><span class="p">.</span><span class="nf">stubs</span><span class="p">(</span><span class="ss">:initial_code</span><span class="p">).</span><span class="nf">returns</span><span class="p">(</span><span class="s1">'devenv'</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">if</span> <span class="s1">'test'</span><span class="p">.</span><span class="nf">eql?</span><span class="p">(</span><span class="no">RAILS_ENV</span><span class="p">)</span>
  <span class="no">PromotionCode</span><span class="p">.</span><span class="nf">stubs</span><span class="p">(</span><span class="ss">:initial_code</span><span class="p">).</span><span class="nf">returns</span><span class="p">(</span><span class="s1">'testenv'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre> <ul> <li>I copied part of the Rakefile from the <code>data_fabric</code> gem to actually be able to migrate the database for the sharded database connections. This was definitely missing from the <code>data_fabric</code> README.</li> </ul> <pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'fileutils'</span>
<span class="kp">include</span> <span class="no">FileUtils</span><span class="o">::</span><span class="no">Verbose</span>

<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">task</span> <span class="ss">:migrate</span> <span class="k">do</span>
    <span class="nb">require</span> <span class="s1">'erb'</span>
    <span class="nb">require</span> <span class="s1">'logger'</span>
    <span class="nb">require</span> <span class="s1">'active_record'</span>

    <span class="n">reference</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">::</span><span class="nb">load</span><span class="p">(</span><span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">IO</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s2">"config/database.yml"</span><span class="p">)).</span><span class="nf">result</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="no">RAILS_ENV</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'RAILS_ENV'</span><span class="p">]</span> <span class="o">||</span> <span class="s1">'development'</span>

    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">level</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">::</span><span class="no">WARN</span>
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">configurations</span> <span class="o">=</span> <span class="n">reference</span><span class="p">.</span><span class="nf">dup</span>
    <span class="n">old_config</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="n">env</span><span class="p">]</span>
    <span class="n">reference</span><span class="p">.</span><span class="nf">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
      <span class="k">next</span> <span class="k">unless</span> <span class="nb">name</span><span class="p">.</span><span class="nf">include?</span> <span class="n">env</span>
      <span class="k">next</span> <span class="k">if</span> <span class="nb">name</span><span class="p">.</span><span class="nf">include?</span> <span class="s1">'slave'</span> <span class="c1"># Replicated databases should not be touched directly</span>

      <span class="nb">puts</span> <span class="s2">"Migrating </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span>
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">clear_active_connections!</span>
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">configurations</span><span class="p">[</span><span class="n">env</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span>
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="no">RAILS_ENV</span>
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">.</span><span class="nf">verbose</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"VERBOSE"</span><span class="p">]</span> <span class="p">?</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"VERBOSE"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"true"</span> <span class="p">:</span> <span class="kp">true</span>
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migrator</span><span class="p">.</span><span class="nf">migrate</span><span class="p">(</span><span class="s2">"db/migrate/"</span><span class="p">,</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"VERSION"</span><span class="p">]</span> <span class="p">?</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"VERSION"</span><span class="p">].</span><span class="nf">to_i</span> <span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <ul> <li>In my test classes that use the sharded model, I have setup and teardown methods that activate and deactivate the shard.</li> </ul> <pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">setup</span>
  <span class="no">DataFabric</span><span class="p">.</span><span class="nf">activate_shard</span><span class="p">(</span><span class="ss">:initial_code</span> <span class="o">=&gt;</span> <span class="s1">'testenv'</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">teardown</span>
  <span class="no">MyAppModel</span><span class="p">.</span><span class="nf">delete_all</span>
  <span class="no">DataFabric</span><span class="p">.</span><span class="nf">deactivate_shard</span><span class="p">(</span><span class="ss">:initial_code</span> <span class="o">=&gt;</span> <span class="s1">'testenv'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre> <p>I did find that I needed to delete all the objects in the database for the sharded model. I&rsquo;m still digging into why that&rsquo;s the case. My ActiveRecord_fu isn&rsquo;t that strong I guess.</p> <p>All in all, sharding is relatively easy with data_fabric. Pimping, however, &ldquo;ain&rsquo;t easy.&rdquo; But that&rsquo;s for another blog post I guess.</p> </div> </div> </div> </div> <div class=blog-pagination> <ul class=inline-list> <li> <a href="/blog/page/24/">« Older entries </a></li> <li>Page 23 of 28</li> <li> <a href="/blog/page/22/">Newer entries » </a></li> </ul> </div> </div> <div class='columns large-3'> <div class=blog-archives-sidebar> <h2>Blog archives</h2> <h3> <a href="/blog/2015/">2015</a> </h3> <ul> <li> <a href="/blog/2015/10/">October 2015</a> </li> <li> <a href="/blog/2015/03/">March 2015</a> </li> <li> <a href="/blog/2015/01/">January 2015</a> </li> </ul> <h3> <a href="/blog/2014/">2014</a> </h3> <ul> <li> <a href="/blog/2014/12/">December 2014</a> </li> <li> <a href="/blog/2014/11/">November 2014</a> </li> <li> <a href="/blog/2014/10/">October 2014</a> </li> <li> <a href="/blog/2014/08/">August 2014</a> </li> <li> <a href="/blog/2014/07/">July 2014</a> </li> <li> <a href="/blog/2014/06/">June 2014</a> </li> <li> <a href="/blog/2014/04/">April 2014</a> </li> <li> <a href="/blog/2014/03/">March 2014</a> </li> <li> <a href="/blog/2014/02/">February 2014</a> </li> <li> <a href="/blog/2014/01/">January 2014</a> </li> </ul> <h3> <a href="/blog/2013/">2013</a> </h3> <ul> <li> <a href="/blog/2013/11/">November 2013</a> </li> <li> <a href="/blog/2013/10/">October 2013</a> </li> <li> <a href="/blog/2013/09/">September 2013</a> </li> <li> <a href="/blog/2013/08/">August 2013</a> </li> <li> <a href="/blog/2013/07/">July 2013</a> </li> <li> <a href="/blog/2013/06/">June 2013</a> </li> <li> <a href="/blog/2013/05/">May 2013</a> </li> <li> <a href="/blog/2013/04/">April 2013</a> </li> <li> <a href="/blog/2013/03/">March 2013</a> </li> <li> <a href="/blog/2013/02/">February 2013</a> </li> <li> <a href="/blog/2013/01/">January 2013</a> </li> </ul> <h3> <a href="/blog/2012/">2012</a> </h3> <ul> <li> <a href="/blog/2012/12/">December 2012</a> </li> <li> <a href="/blog/2012/11/">November 2012</a> </li> <li> <a href="/blog/2012/10/">October 2012</a> </li> <li> <a href="/blog/2012/09/">September 2012</a> </li> <li> <a href="/blog/2012/08/">August 2012</a> </li> <li> <a href="/blog/2012/07/">July 2012</a> </li> <li> <a href="/blog/2012/06/">June 2012</a> </li> <li> <a href="/blog/2012/05/">May 2012</a> </li> <li> <a href="/blog/2012/04/">April 2012</a> </li> <li> <a href="/blog/2012/03/">March 2012</a> </li> <li> <a href="/blog/2012/02/">February 2012</a> </li> <li> <a href="/blog/2012/01/">January 2012</a> </li> </ul> <h3> <a href="/blog/2011/">2011</a> </h3> <ul> <li> <a href="/blog/2011/10/">October 2011</a> </li> <li> <a href="/blog/2011/09/">September 2011</a> </li> <li> <a href="/blog/2011/08/">August 2011</a> </li> <li> <a href="/blog/2011/07/">July 2011</a> </li> <li> <a href="/blog/2011/06/">June 2011</a> </li> <li> <a href="/blog/2011/05/">May 2011</a> </li> <li> <a href="/blog/2011/04/">April 2011</a> </li> <li> <a href="/blog/2011/03/">March 2011</a> </li> <li> <a href="/blog/2011/02/">February 2011</a> </li> <li> <a href="/blog/2011/01/">January 2011</a> </li> </ul> <h3> <a href="/blog/2010/">2010</a> </h3> <ul> <li> <a href="/blog/2010/12/">December 2010</a> </li> <li> <a href="/blog/2010/11/">November 2010</a> </li> <li> <a href="/blog/2010/10/">October 2010</a> </li> <li> <a href="/blog/2010/09/">September 2010</a> </li> <li> <a href="/blog/2010/08/">August 2010</a> </li> <li> <a href="/blog/2010/07/">July 2010</a> </li> <li> <a href="/blog/2010/06/">June 2010</a> </li> <li> <a href="/blog/2010/05/">May 2010</a> </li> <li> <a href="/blog/2010/04/">April 2010</a> </li> <li> <a href="/blog/2010/03/">March 2010</a> </li> <li> <a href="/blog/2010/02/">February 2010</a> </li> <li> <a href="/blog/2010/01/">January 2010</a> </li> </ul> <h3> <a href="/blog/2009/">2009</a> </h3> <ul> <li> <a href="/blog/2009/12/">December 2009</a> </li> <li> <a href="/blog/2009/11/">November 2009</a> </li> <li> <a href="/blog/2009/10/">October 2009</a> </li> <li> <a href="/blog/2009/09/">September 2009</a> </li> <li> <a href="/blog/2009/08/">August 2009</a> </li> <li> <a href="/blog/2009/07/">July 2009</a> </li> <li> <a href="/blog/2009/06/">June 2009</a> </li> <li> <a href="/blog/2009/05/">May 2009</a> </li> <li> <a href="/blog/2009/04/">April 2009</a> </li> <li> <a href="/blog/2009/03/">March 2009</a> </li> <li> <a href="/blog/2009/02/">February 2009</a> </li> <li> <a href="/blog/2009/01/">January 2009</a> </li> </ul> <h3> <a href="/blog/2008/">2008</a> </h3> <ul> <li> <a href="/blog/2008/11/">November 2008</a> </li> <li> <a href="/blog/2008/10/">October 2008</a> </li> <li> <a href="/blog/2008/09/">September 2008</a> </li> <li> <a href="/blog/2008/08/">August 2008</a> </li> </ul> </div> </div> </div> <script src="/assets/javascripts/app-8d34dc05.js" async=true></script> </body> </html>