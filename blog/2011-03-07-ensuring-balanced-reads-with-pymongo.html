<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><meta content="width=device-width" name="viewport"><title>Ensuring balanced reads with PyMongo</title><link href="../assets/images/favicon.ico" rel="shortcut icon"><link href="../assets/stylesheets/all-dc5d1bf2.css" media="all" rel="stylesheet" type="text/css" /><!--[if lt IE 9]><script src="../assets/javascripts/vendor/html5shiv-8b3747c5.js" type="text/javascript"></script><![endif]--></head><body><div class="outer-wrap"><div class="inner-wrap"><div class="wrap"><header class="clearfix" id="page"><a href="/"><img alt="Agora Games" id="logo" src="../assets/images/agora-games-logo-e99b2824.png"></a><nav><ul><li><a href="https://hydra.agoragames.com/">Products</a></li><li><a href="/portfolio.html">Customers</a></li><li><a href="/us.html">Team</a></li><li><a href="/community.html">Community</a></li><li><a href="/work-at-agora.html">Jobs</a></li><li><a href="/blog/">Blog</a></li></ul></nav></header></div><div class="wrap"><article class="clearfix"><header><h1>The <strong>Blog</strong></h1></header><section id="blog-entry"><div class="blog-entry"><div class="date-comments"><div class="date">Mar 7</div></div><div class="blog-content"><h2>Ensuring balanced reads with PyMongo</h2><div class="blog-author">By <strong>Aaron Westendorf</strong></div><div class="blog-body"><p>Over the past year we've been evaluating and migrating many of our game services over to <a href="http://www.mongodb.org/">mongoDB</a>. Its feature set gives us complete freedom to iterate with developers during game production, its performance is sufficient to power our infrastructure during peak load, our operations team appreciate its powerful administration tools, and 10gen has so far proven itself a reliable technology partner and steward of the Mongo roadmap. One of the very important features of PyMongo that we have made use of is the MasterSlaveConnection, but it's not without its caveats, one of those being that it does not guarantee you are balancing your reads across a replica set.</p>

<p>Before we dig in, a few items of note. First, the situation I'm covering here is specifically when you're connecting directly to a <a href="http://www.mongodb.org/display/DOCS/Replica+Sets">replica set</a>. There may be a similar pattern to follow on a sharded database, but that's outside the scope of this post and what our team is working with. Secondly, if you're not familiar with the <a href="http://api.mongodb.org/python/1.9%2B/api/pymongo/master_slave_connection.html">MasterSlaveConnection</a>, the gist of the class is that it directs all writes to the current master, and randomly choses a slave for each read-only query. Lastly, we have some pending <a href="https://github.com/mongodb/mongo-python-driver/pull/24">patches</a> to pymongo 1.9 that I recommend applying before you begin, as they'll affect your ability to use the MasterSlaveConnection and seamlessly restart or shutdown hosts in your replica set.</p>

<p>The situation we're correcting for here is where we have a replica set, with one or more slaves, and we want to maintain balanced reads across them. Our application is long running, and at any time the operations team may remove a host from the replica set to perform maintenance. Mongo and pymongo will work together to ensure high availability failover, but once you've brought your replica set back to full capacity, your application will not connect to that host unless there's another socket disconnect, and even then not guarantee it will connect to the original host. You've now lost a substantial amount of performance and scalability until your application has restarted.</p>

<p>{% gist 858617 %}</p>

<p>Read through connection() to understand the basics of instantiating a MasterSlaveConnection, or in this case our subclass ClusterConnection. It is initialized with a single Connection to the master, and then for each host in our list, we create a slave Connection. The Connection class is smart in that it can maintain a list of hosts, both configured and discovered from the replica set, and connect to any one of them at any time. The master Connection will always connect to the current master out of our list of hosts and handle when the master changes. The slave connections are configured with slave_okay=True so that they'll stay connected to whichever host we tell them and failover to other slaves, and _connect=False is passed so that if a slave is not currently available, Connection and MasterSlaveConnection can kindly follow their AutoReconnect paths without interrupting your application. So long as you have just the master up, you'll never know that the replica set may be impaired at the time you initialize the connection.</p>

<p>The class ApplicationDatabaseInterface is simply an example of whatever you use to maintain an interface to the database within your application. The only requirement here is that we have some ability to cache an existing MasterSlaveConnection and call validate_slaves() on it before we use it. I recommend validating the slaves only once per application "transaction", however that may apply to your use case (see query() in the example above).</p>

<p>The validate_slaves() method is really where the important work is done. This example implementation will check for us every 5 minutes, but your criteria and interval can be whatever suites your needs. First it uses the same code as pymongo to parse the slave URIs so you can support host and port schemes. It walks through all of the slaves and if the current host and port of a Connection are not in the list of configured hosts, closes that connection and removes it from the slave list. If there are any hosts in our list of slaves which do not have a connection, it then re-populates the slave list with a fresh Connection for that host. The new connection also includes the _connect=False flag, so we'll never get an AutoReconnect exception in case a slave is not available at the time this code is run.</p>

<p>The reason we remove connections from the slave list is because the Connection class doesn't maintain its internal list of possible hosts in any <a href="http://jira.mongodb.org/browse/PYTHON-218">priority</a>. If we simply closed the connection it will reconnect, but we aren't guaranteed that it will reconnect to its originally-configured host, and that's what we're trying to ensure.</p>

<p>The last important bit of this is the with_reconnect decorator. It's not strictly required, but for completeness, you should have something like this in your stack when communicating with Mongo. In addition to connection drops, there are situations such as <a href="http://jira.mongodb.org/browse/PYTHON-216">this</a> where the driver will raise an AutoReconnect because the replica set is in transition. I've found that 2 seconds is about the maximum amount of time it takes for pymongo and the replica set to agree that all is well with the world, so this example decorator gives enough time for that situation to resolve itself.</p>
</div></div></div></section><aside id="sidebar"><div class="block" id="block-archive"><h2>Blog archives</h2><h3>2013</h3><ul><li><a href="/blog/2013/11.html">November 2013</a></li><li><a href="/blog/2013/10.html">October 2013</a></li><li><a href="/blog/2013/09.html">September 2013</a></li><li><a href="/blog/2013/08.html">August 2013</a></li><li><a href="/blog/2013/07.html">July 2013</a></li><li><a href="/blog/2013/06.html">June 2013</a></li><li><a href="/blog/2013/05.html">May 2013</a></li><li><a href="/blog/2013/04.html">April 2013</a></li><li><a href="/blog/2013/03.html">March 2013</a></li><li><a href="/blog/2013/02.html">February 2013</a></li><li><a href="/blog/2013/01.html">January 2013</a></li></ul><h3>2012</h3><ul><li><a href="/blog/2012/12.html">December 2012</a></li><li><a href="/blog/2012/11.html">November 2012</a></li><li><a href="/blog/2012/10.html">October 2012</a></li><li><a href="/blog/2012/09.html">September 2012</a></li><li><a href="/blog/2012/08.html">August 2012</a></li><li><a href="/blog/2012/07.html">July 2012</a></li><li><a href="/blog/2012/06.html">June 2012</a></li><li><a href="/blog/2012/05.html">May 2012</a></li><li><a href="/blog/2012/04.html">April 2012</a></li><li><a href="/blog/2012/03.html">March 2012</a></li><li><a href="/blog/2012/02.html">February 2012</a></li><li><a href="/blog/2012/01.html">January 2012</a></li></ul><h3>2011</h3><ul><li><a href="/blog/2011/10.html">October 2011</a></li><li><a href="/blog/2011/09.html">September 2011</a></li><li><a href="/blog/2011/08.html">August 2011</a></li><li><a href="/blog/2011/07.html">July 2011</a></li><li><a href="/blog/2011/06.html">June 2011</a></li><li><a href="/blog/2011/05.html">May 2011</a></li><li><a href="/blog/2011/04.html">April 2011</a></li><li><a href="/blog/2011/03.html">March 2011</a></li><li><a href="/blog/2011/02.html">February 2011</a></li><li><a href="/blog/2011/01.html">January 2011</a></li></ul><h3>2010</h3><ul><li><a href="/blog/2010/12.html">December 2010</a></li><li><a href="/blog/2010/11.html">November 2010</a></li><li><a href="/blog/2010/10.html">October 2010</a></li><li><a href="/blog/2010/09.html">September 2010</a></li><li><a href="/blog/2010/08.html">August 2010</a></li><li><a href="/blog/2010/07.html">July 2010</a></li><li><a href="/blog/2010/06.html">June 2010</a></li><li><a href="/blog/2010/05.html">May 2010</a></li><li><a href="/blog/2010/04.html">April 2010</a></li><li><a href="/blog/2010/03.html">March 2010</a></li><li><a href="/blog/2010/02.html">February 2010</a></li><li><a href="/blog/2010/01.html">January 2010</a></li></ul><h3>2009</h3><ul><li><a href="/blog/2009/12.html">December 2009</a></li><li><a href="/blog/2009/11.html">November 2009</a></li><li><a href="/blog/2009/10.html">October 2009</a></li><li><a href="/blog/2009/09.html">September 2009</a></li><li><a href="/blog/2009/08.html">August 2009</a></li><li><a href="/blog/2009/07.html">July 2009</a></li><li><a href="/blog/2009/06.html">June 2009</a></li><li><a href="/blog/2009/05.html">May 2009</a></li><li><a href="/blog/2009/04.html">April 2009</a></li><li><a href="/blog/2009/03.html">March 2009</a></li><li><a href="/blog/2009/02.html">February 2009</a></li><li><a href="/blog/2009/01.html">January 2009</a></li></ul><h3>2008</h3><ul><li><a href="/blog/2008/11.html">November 2008</a></li><li><a href="/blog/2008/10.html">October 2008</a></li><li><a href="/blog/2008/09.html">September 2008</a></li><li><a href="/blog/2008/08.html">August 2008</a></li></ul></div></aside></article></div></div></div><footer><div class="outer-wrap"><div class="wrap"><div id="copyright"><img alt="Agora Games" src="../assets/images/agora-logo-agga-7c1d9a1f.png"> <a href="http://majorleaguegaming.com" target="_blank"><img alt="Major League Gaming" src="../assets/images/mlg-logo-28545055.png"></a><a href="mailto:info@agoragames.com" id="email-us">Email Us</a><p>359 Broadway, Third Floor, Troy, NY 12180</p><p class="dim">&copy; 2013 Agora Games. All Rights Reserved.</p></div></div></div></footer><div class="hide"><iframe id="wufoo-iframe" src="javascript:void(0)"></iframe><a id="wufoo-thanks" href="/thanks.html"></a></div><!--[if lt IE 9]>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<![endif]-->
<!--[if gte IE 9]><!-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<!--<![endif]-->
<script>
  if (!window.jQuery) {
    document.write('<script type="text/javascript" src="../assets/javascripts/vendor/jquery.min-199fc76d.js"><' + '/script>');
  }
</script>
<script src="../assets/javascripts/all-7e4f2f03.js" type="text/javascript"></script></body></html>