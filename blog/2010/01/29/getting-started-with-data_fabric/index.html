<!DOCTYPE html> <html class=no-js lang=en> <head> <meta charset=utf-8> <meta content='width=device-width, initial-scale=1.0' name=viewport> <meta content='IE=edge,chrome=1' http-equiv=X-UA-Compatible> <title>Getting started with data_fabric</title> <link href="/assets/stylesheets/app-afc0a2ef.css" rel=stylesheet /> <script src="/assets/javascripts/modernizr-84a49412.js"></script> <link href='/assets/images/favicon.ico' rel='shortcut icon'> </head> <body class='blog blog_2010 blog_2010_01 blog_2010_01_29 blog_2010_01_29_getting-started-with-data_fabric blog_2010_01_29_getting-started-with-data_fabric_index f-topbar-fixed'> <div class='fixed raised'> <nav class=top-bar data-topbar role=navigation> <ul class=title-area> <li class=name> <h1> <a href='/'> <img alt="Agora Games" class=main-logo src="/assets/images/agoragames-new-8534f601.svg"/> </a> </h1> </li> <li class='toggle-topbar menu-icon'> <a href='javascript:void(0)'> <span>Menu</span> </a> </li> </ul> <section class=top-bar-section> <ul class=right> <li> <a data-anchor href='/#about'>About</a> </li> <li> <a data-anchor href='/#team'>Team</a> </li> <li> <a data-anchor href='/#contact'>Contact</a> </li> <li> <a href='/careers'>Careers</a> </li> <li> <a href='/blog'>Blog</a> </li> <li class=hydra-theme> <a href='http://hydra.agoragames.com'> <img alt=Hydra width=92 src="/assets/images/hydra-wordmark-6248cf07.svg"/> </a> </li> </ul> </section> </nav> </div> <div class=row> <div class=columns> <h1 class=blog-page-title> <a href="/blog">The <strong>Blog</strong> </a></h1> </div> </div> <div class=row> <div class='columns large-9'> <h2 class=blog__title> <a href="/blog/2010/01/29/getting-started-with-data_fabric/">Getting started with data_fabric</a> </h2> <div class=blog__author> By <strong>David Czarnecki</strong> </div> <div class=blog__date> Friday, January 29, 2010 </div> <div class=blog__body> <p>The <a href="http://github.com/mperham/data_fabric">data_fabric</a> gem &ldquo;provides flexible database connection switching for ActiveRecord&rdquo;. If you&rsquo;re not concerned with database sharding, you might want to skip this blog post. Or not. Either way, I&rsquo;m not going to be offended.</p> <p>I have a requirement that certain data in an application that I&rsquo;m developing will probably have to be sharded because, if you&rsquo;ll excuse my English, there will a &ldquo;shit ton&rdquo; of data. This only affects one model out of the few models I have in the application. I don&rsquo;t have a requirement that the data will be replicated (which is another feature supported in <code>data_fabric</code>), so I&rsquo;m not going into that here. In any event, here is a rundown of how I got started developing and testing with <code>data_fabric</code>.</p> <ul> <li>Configure the <code>data_fabric</code> gem in your <code>config/environment.rb</code> file.</li> </ul> <pre class="highlight ruby"><code><span class="n">config</span><span class="p">.</span><span class="nf">gem</span> <span class="s1">'data_fabric'</span>
</code></pre> <ul> <li>In your model(s), decide on which column or how the data is going to be shared.</li> </ul> <pre class="highlight ruby"><code><span class="n">data_fabric</span> <span class="ss">:replicated</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:shard_by</span> <span class="o">=&gt;</span> <span class="ss">:initial_code</span>
</code></pre> <p>In this case, inital_code is a method that looks at a piece of the model&rsquo;s data and gives me the correct shard.</p> <ul> <li>Setup the database shards in your <code>config/database.yml</code> file. I actually setup only one shard for development and testing environments to make things easier. I&rsquo;m just including the one for the test environment here. You can read on the <code>data_fabric</code> site about the naming convention for sharded database connections.</li> </ul> <pre class="highlight yaml"><code><span class="s">test</span><span class="pi">:</span>
<span class="s">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="s">encoding</span><span class="pi">:</span> <span class="s">utf8</span>
<span class="s">reconnect</span><span class="pi">:</span> <span class="s">false</span>
<span class="s">database</span><span class="pi">:</span> <span class="s">myapp_test</span>
<span class="s">pool</span><span class="pi">:</span> <span class="s">5</span>
<span class="s">username</span><span class="pi">:</span> <span class="s">root</span>
<span class="s">password</span><span class="pi">:</span>

<span class="c1"># This is the database shard</span>
<span class="s">initial_code_testenv_test</span><span class="pi">:</span>
<span class="s">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="s">encoding</span><span class="pi">:</span> <span class="s">utf8</span>
<span class="s">reconnect</span><span class="pi">:</span> <span class="s">false</span>
<span class="s">database</span><span class="pi">:</span> <span class="s">myapp_test_testenv</span>
<span class="s">pool</span><span class="pi">:</span> <span class="s">5</span>
<span class="s">username</span><span class="pi">:</span> <span class="s">root</span>
<span class="s">password</span><span class="pi">:</span>
</code></pre> <ul> <li>In <code>config/initializers/my_app_model.rb</code>, I actually stub out the initial_code method to return a single value for the development and test environments. This is merely convenience so I don&rsquo;t have to include every single database shard for development and testing.</li> </ul> <pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'mocha'</span>

<span class="k">if</span> <span class="s1">'development'</span><span class="p">.</span><span class="nf">eql?</span><span class="p">(</span><span class="no">RAILS_ENV</span><span class="p">)</span>
  <span class="no">PromotionCode</span><span class="p">.</span><span class="nf">stubs</span><span class="p">(</span><span class="ss">:initial_code</span><span class="p">).</span><span class="nf">returns</span><span class="p">(</span><span class="s1">'devenv'</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">if</span> <span class="s1">'test'</span><span class="p">.</span><span class="nf">eql?</span><span class="p">(</span><span class="no">RAILS_ENV</span><span class="p">)</span>
  <span class="no">PromotionCode</span><span class="p">.</span><span class="nf">stubs</span><span class="p">(</span><span class="ss">:initial_code</span><span class="p">).</span><span class="nf">returns</span><span class="p">(</span><span class="s1">'testenv'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre> <ul> <li>I copied part of the Rakefile from the <code>data_fabric</code> gem to actually be able to migrate the database for the sharded database connections. This was definitely missing from the <code>data_fabric</code> README.</li> </ul> <pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'fileutils'</span>
<span class="kp">include</span> <span class="no">FileUtils</span><span class="o">::</span><span class="no">Verbose</span>

<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">task</span> <span class="ss">:migrate</span> <span class="k">do</span>
    <span class="nb">require</span> <span class="s1">'erb'</span>
    <span class="nb">require</span> <span class="s1">'logger'</span>
    <span class="nb">require</span> <span class="s1">'active_record'</span>

    <span class="n">reference</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">::</span><span class="nb">load</span><span class="p">(</span><span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">IO</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s2">"config/database.yml"</span><span class="p">)).</span><span class="nf">result</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="no">RAILS_ENV</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'RAILS_ENV'</span><span class="p">]</span> <span class="o">||</span> <span class="s1">'development'</span>

    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">level</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">::</span><span class="no">WARN</span>
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">configurations</span> <span class="o">=</span> <span class="n">reference</span><span class="p">.</span><span class="nf">dup</span>
    <span class="n">old_config</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="n">env</span><span class="p">]</span>
    <span class="n">reference</span><span class="p">.</span><span class="nf">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
      <span class="k">next</span> <span class="k">unless</span> <span class="nb">name</span><span class="p">.</span><span class="nf">include?</span> <span class="n">env</span>
      <span class="k">next</span> <span class="k">if</span> <span class="nb">name</span><span class="p">.</span><span class="nf">include?</span> <span class="s1">'slave'</span> <span class="c1"># Replicated databases should not be touched directly</span>

      <span class="nb">puts</span> <span class="s2">"Migrating </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span>
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">clear_active_connections!</span>
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">configurations</span><span class="p">[</span><span class="n">env</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span>
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="no">RAILS_ENV</span>
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">.</span><span class="nf">verbose</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"VERBOSE"</span><span class="p">]</span> <span class="p">?</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"VERBOSE"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"true"</span> <span class="p">:</span> <span class="kp">true</span>
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migrator</span><span class="p">.</span><span class="nf">migrate</span><span class="p">(</span><span class="s2">"db/migrate/"</span><span class="p">,</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"VERSION"</span><span class="p">]</span> <span class="p">?</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"VERSION"</span><span class="p">].</span><span class="nf">to_i</span> <span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <ul> <li>In my test classes that use the sharded model, I have setup and teardown methods that activate and deactivate the shard.</li> </ul> <pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">setup</span>
  <span class="no">DataFabric</span><span class="p">.</span><span class="nf">activate_shard</span><span class="p">(</span><span class="ss">:initial_code</span> <span class="o">=&gt;</span> <span class="s1">'testenv'</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">teardown</span>
  <span class="no">MyAppModel</span><span class="p">.</span><span class="nf">delete_all</span>
  <span class="no">DataFabric</span><span class="p">.</span><span class="nf">deactivate_shard</span><span class="p">(</span><span class="ss">:initial_code</span> <span class="o">=&gt;</span> <span class="s1">'testenv'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre> <p>I did find that I needed to delete all the objects in the database for the sharded model. I&rsquo;m still digging into why that&rsquo;s the case. My ActiveRecord_fu isn&rsquo;t that strong I guess.</p> <p>All in all, sharding is relatively easy with data_fabric. Pimping, however, &ldquo;ain&rsquo;t easy.&rdquo; But that&rsquo;s for another blog post I guess.</p> </div> </div> <div class='columns large-3'> <div class=blog-archives-sidebar> <h2>Blog archives</h2> <h3> <a href="/blog/2015/">2015</a> </h3> <ul> <li> <a href="/blog/2015/10/">October 2015</a> </li> <li> <a href="/blog/2015/03/">March 2015</a> </li> <li> <a href="/blog/2015/01/">January 2015</a> </li> </ul> <h3> <a href="/blog/2014/">2014</a> </h3> <ul> <li> <a href="/blog/2014/12/">December 2014</a> </li> <li> <a href="/blog/2014/11/">November 2014</a> </li> <li> <a href="/blog/2014/10/">October 2014</a> </li> <li> <a href="/blog/2014/08/">August 2014</a> </li> <li> <a href="/blog/2014/07/">July 2014</a> </li> <li> <a href="/blog/2014/06/">June 2014</a> </li> <li> <a href="/blog/2014/04/">April 2014</a> </li> <li> <a href="/blog/2014/03/">March 2014</a> </li> <li> <a href="/blog/2014/02/">February 2014</a> </li> <li> <a href="/blog/2014/01/">January 2014</a> </li> </ul> <h3> <a href="/blog/2013/">2013</a> </h3> <ul> <li> <a href="/blog/2013/11/">November 2013</a> </li> <li> <a href="/blog/2013/10/">October 2013</a> </li> <li> <a href="/blog/2013/09/">September 2013</a> </li> <li> <a href="/blog/2013/08/">August 2013</a> </li> <li> <a href="/blog/2013/07/">July 2013</a> </li> <li> <a href="/blog/2013/06/">June 2013</a> </li> <li> <a href="/blog/2013/05/">May 2013</a> </li> <li> <a href="/blog/2013/04/">April 2013</a> </li> <li> <a href="/blog/2013/03/">March 2013</a> </li> <li> <a href="/blog/2013/02/">February 2013</a> </li> <li> <a href="/blog/2013/01/">January 2013</a> </li> </ul> <h3> <a href="/blog/2012/">2012</a> </h3> <ul> <li> <a href="/blog/2012/12/">December 2012</a> </li> <li> <a href="/blog/2012/11/">November 2012</a> </li> <li> <a href="/blog/2012/10/">October 2012</a> </li> <li> <a href="/blog/2012/09/">September 2012</a> </li> <li> <a href="/blog/2012/08/">August 2012</a> </li> <li> <a href="/blog/2012/07/">July 2012</a> </li> <li> <a href="/blog/2012/06/">June 2012</a> </li> <li> <a href="/blog/2012/05/">May 2012</a> </li> <li> <a href="/blog/2012/04/">April 2012</a> </li> <li> <a href="/blog/2012/03/">March 2012</a> </li> <li> <a href="/blog/2012/02/">February 2012</a> </li> <li> <a href="/blog/2012/01/">January 2012</a> </li> </ul> <h3> <a href="/blog/2011/">2011</a> </h3> <ul> <li> <a href="/blog/2011/10/">October 2011</a> </li> <li> <a href="/blog/2011/09/">September 2011</a> </li> <li> <a href="/blog/2011/08/">August 2011</a> </li> <li> <a href="/blog/2011/07/">July 2011</a> </li> <li> <a href="/blog/2011/06/">June 2011</a> </li> <li> <a href="/blog/2011/05/">May 2011</a> </li> <li> <a href="/blog/2011/04/">April 2011</a> </li> <li> <a href="/blog/2011/03/">March 2011</a> </li> <li> <a href="/blog/2011/02/">February 2011</a> </li> <li> <a href="/blog/2011/01/">January 2011</a> </li> </ul> <h3> <a href="/blog/2010/">2010</a> </h3> <ul> <li> <a href="/blog/2010/12/">December 2010</a> </li> <li> <a href="/blog/2010/11/">November 2010</a> </li> <li> <a href="/blog/2010/10/">October 2010</a> </li> <li> <a href="/blog/2010/09/">September 2010</a> </li> <li> <a href="/blog/2010/08/">August 2010</a> </li> <li> <a href="/blog/2010/07/">July 2010</a> </li> <li> <a href="/blog/2010/06/">June 2010</a> </li> <li> <a href="/blog/2010/05/">May 2010</a> </li> <li> <a href="/blog/2010/04/">April 2010</a> </li> <li> <a href="/blog/2010/03/">March 2010</a> </li> <li> <a href="/blog/2010/02/">February 2010</a> </li> <li> <a href="/blog/2010/01/">January 2010</a> </li> </ul> <h3> <a href="/blog/2009/">2009</a> </h3> <ul> <li> <a href="/blog/2009/12/">December 2009</a> </li> <li> <a href="/blog/2009/11/">November 2009</a> </li> <li> <a href="/blog/2009/10/">October 2009</a> </li> <li> <a href="/blog/2009/09/">September 2009</a> </li> <li> <a href="/blog/2009/08/">August 2009</a> </li> <li> <a href="/blog/2009/07/">July 2009</a> </li> <li> <a href="/blog/2009/06/">June 2009</a> </li> <li> <a href="/blog/2009/05/">May 2009</a> </li> <li> <a href="/blog/2009/04/">April 2009</a> </li> <li> <a href="/blog/2009/03/">March 2009</a> </li> <li> <a href="/blog/2009/02/">February 2009</a> </li> <li> <a href="/blog/2009/01/">January 2009</a> </li> </ul> <h3> <a href="/blog/2008/">2008</a> </h3> <ul> <li> <a href="/blog/2008/11/">November 2008</a> </li> <li> <a href="/blog/2008/10/">October 2008</a> </li> <li> <a href="/blog/2008/09/">September 2008</a> </li> <li> <a href="/blog/2008/08/">August 2008</a> </li> </ul> </div> </div> </div> <script src="/assets/javascripts/app-8d34dc05.js" async=true></script> </body> </html>