<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><meta content="width=device-width" name="viewport"><title>Brain Matters</title><link href="/assets/images/favicon.ico" rel="shortcut icon"><link href="/assets/stylesheets/all-88a72572.css" media="all" rel="stylesheet" type="text/css" /><!--[if lt IE 9]><script src="/assets/javascripts/vendor/html5shiv-8b3747c5.js" type="text/javascript"></script><![endif]--></head><body><div class="outer-wrap"><div class="inner-wrap"><div class="wrap"><header class="clearfix" id="page"><a href="/"><img alt="Agora Games" id="logo" src="/assets/images/agora-games-logo-be83adf8.png"></a><nav><ul><li><a href="https://hydra.agoragames.com/">Products</a></li><li><a href="/portfolio/">Customers</a></li><li><a href="/us/">Team</a></li><li><a href="/community/">Community</a></li><li><a href="/work-at-agora/">Jobs</a></li><li><a href="/blog/">Blog</a></li></ul></nav></header></div><div class="wrap"><article class="clearfix"><header><h1>January  4, 2010</h1></header><section id="blog-entries"><div class="blog-entry"><div class="date-comments"><div class="date">Jan 4</div></div><div class="blog-content"><h2><a href="/blog/2010/01/04/scaling-ruby-and-rails-part-1/">Scaling Ruby and Rails Part 1</a></h2><div class="blog-author">By <strong>David Czarnecki</strong></div><div class="blog-body"><p>I wish scaling applications and systems these days consisted solely of " <a href="http://olabini.com/blog/2008/05/just-add-scaling/">Just Add Scaling!</a>". But you know what? It's not. I also forget where I read it, but the quote went something like, "Programming languages don't scale, architectures scale." Scaling is driven by proper iterative design, implementation and testing.</p>

<p>In a series of blog posts I want to cover how we have approached scaling out various parts of our Ruby and Rails infrastructure here at Agora Games using real-world examples on very high-traffic sites such as the Guitar Hero and Call of Duty community sites.</p>

<p>Here I'll cover the "Deep Dive". I originally came from BigCo. and there we used a concept called the "Deep Dive", which involved taking a specific requirement in combination with an approach or technology and following a thread of execution that would take you through the entire technology stack, or a "deep dive" through the system. At the end you would either prove or disprove the technology or approach. But it was done in the context of a real set of requirements.</p>

<p>The following is the e-mail (project/features names changed to protect the innocent … the important concept here is the Deep Dive, not the project/features) I sent around to our engineering team in September of last year after doing a Deep Dive on a queue system.</p>

<hr />

<blockquote>
  <p>From: David Czarnecki</p>
</blockquote>

<p>To: Engineering</p>

<p>Clearly Defined Requirement(s)</p>

<p>Ultimately, to do a deep dive correctly, you need clearly defined requirements to evaluate your technology or approach against. In the case of PROJECT X, with the use of a queue, we had the following:</p>

<p>Setup queue
 Decide event(s)
 Send to queue
 Aggregate from/to queue
 Put into message creation
 Send back to the app</p>

<p>Narrowing the Field</p>

<p>I spent a day looking at various queue packages in Ruby and other languages to understand:</p>

<p>Features - What features do we get out of the package?
 API - How easy is it to setup/create/interact with the queue from actual code?
 Aliveness - Is this an ongoing effort or was it thrown on RubyForge and ultimately abandoned?
 Community - Where is this package being used? How many developers or contributors commit to the project?
 Language - Are we expanding our technology stack by introducing a queue written in one language with an interface in another language?</p>

<p>Pork, aka The Other Other Requirements</p>

<p>And don't forget about the other "unspoken" requirements.</p>

<p>Ease of setup
 Speed
 Failsafe
 Scaling</p>

<p>At the end of the day, whichever package is picked, you want some guarantee that the package you've chosen is "good" or at least "good enough". But what if the Guarantee Fairy's a crazy glue sniffer? Next thing you know there's change missing from your dresser and your daughter's knocked up. I've seen it a hundred times. Although you've got a set of requirements that define how you're going to use a technology or approach operationally, there are still requirements that need to be addressed, even if there isn't anything formally specified.</p>

<p>Let's Get Ready To Rumble</p>

<p>I chose Sparrow and Rabbit/AMQP since these passed the "ease of setup" requirements with flying colors.</p>

<p><a href="http://code.google.com/p/sparrow/">http://code.google.com/p/sparrow/</a> - Pure Ruby</p>

<p><a href="http://hopper.squarespace.com/blog/2008/7/22/simple-amqp-library-for-ruby.html">http://hopper.squarespace.com/blog/2008/7/22/simple-amqp-library-for-ruby.html</a></p>

<p>Erlang Queue Server/Ruby interface to Queue</p>

<p>Next up it was time to prove out the feasibility of the two technologies looking at the "soft" requirements in the context of the "hard" requirements. This meant setting up the two systems to:</p>

<p>Setup queue
 Send event(s) to queue
 Aggregate from/to queue</p>

<p>The other "hard" requirements would be addressed based on the outcome of this initial sanity check.</p>

<p>2 Queues Enter, 1 Queue Leaves … Wait, what?</p>

<p>Although I wanted to use this to prove out "FEATURE X", I also wanted to address its use in "FEATURE Y". "FEATURE Y" involves converting a song file into an MP3. So I setup a test to evaluate the two systems which was:</p>

<p><code>ruby
1k, 8k, 16k, 32k, 64k messages do
  25.times do
    10000 messages do
      publish message to queue
      read message from queue
    end
  end
end
</code></p>

<p>In other words, publish 10000 messages to the queue (in one process) and read those messages from the queue (in another process), noting how long it took to publish and read. Do this 25 times to get a min/max/average time for each of the different message sizes.</p>

<p>I have attached the spreadsheet of the results which show: the larger the message, the longer it takes to publish and read from the queue. However, it also shows that Sparrow could handle the 64k messages while Rabbit/AMQP could not. Sparrow got slower to process those 10000 64k items from the queue, but it never failed as with Rabbit/AMQP. Ultimately, the deep dive was not about fixing a broken AMQP adapter.</p>

<p>The Devil is in the Details</p>

<p>One benefit of using Sparrow is that persistence is built into the server. If you take down Sparrow and there are messages on the queue, it will write those out to an SQLite3 database. Ultimately this lead me to look at the size of the field it was using for queue data which would need to be patched from its current 255 characters.</p>

<p>Conclusion</p>

<p>So, I've now got a queue server that I feel comfortable setting up and using and that can probably handle the load of data we're going to throw at it come launch. The queue server/queues were integrated into PROJECT X in the context of the "FEATURE X" to prove its feasibility in addressing that feature in a future sprint.</p>

<p>And one more thing …</p>

<p>There are tests for the various bits that make up "FEATURE X". I'm most happy with the integration test which fires up a Sparrow server, fires up a foo, creates a bar, runs the aggregator, and checks to see that a baz was created for the account (oh and then cleaning up the queue server and the subscriber). 14 LOC, but there's a lot of code that it exercises behind the scenes. And yes, it passes :)
<strong>__</strong><strong>__</strong>_____</p>

<p>So, there you go. Hopefully you have enough information to do your own Deep Dive.</p>

<p>Ultimately for FEATURE X and FEATURE Y, Sparrow more than met our needs. Advances and changes to AMQP and its associated libraries have been made which I'm sure make it a more than viable candidate. At the time however, with just getting the system to work for a day to prove out the Deep Dive, it just didn't meet our needs. Again, the point of this blog post is to talk about the Deep Dive in the larger context of its use in Scaling Ruby and Rails.</p>
</div></div></div></section><aside id="sidebar"><div class="block" id="block-archive"><h2>Blog archives</h2><h3>2014</h3><ul><li><a href="/blog/2014/02/">February 2014</a></li><li><a href="/blog/2014/01/">January 2014</a></li></ul><h3>2013</h3><ul><li><a href="/blog/2013/11/">November 2013</a></li><li><a href="/blog/2013/10/">October 2013</a></li><li><a href="/blog/2013/09/">September 2013</a></li><li><a href="/blog/2013/08/">August 2013</a></li><li><a href="/blog/2013/07/">July 2013</a></li><li><a href="/blog/2013/06/">June 2013</a></li><li><a href="/blog/2013/05/">May 2013</a></li><li><a href="/blog/2013/04/">April 2013</a></li><li><a href="/blog/2013/03/">March 2013</a></li><li><a href="/blog/2013/02/">February 2013</a></li><li><a href="/blog/2013/01/">January 2013</a></li></ul><h3>2012</h3><ul><li><a href="/blog/2012/12/">December 2012</a></li><li><a href="/blog/2012/11/">November 2012</a></li><li><a href="/blog/2012/10/">October 2012</a></li><li><a href="/blog/2012/09/">September 2012</a></li><li><a href="/blog/2012/08/">August 2012</a></li><li><a href="/blog/2012/07/">July 2012</a></li><li><a href="/blog/2012/06/">June 2012</a></li><li><a href="/blog/2012/05/">May 2012</a></li><li><a href="/blog/2012/04/">April 2012</a></li><li><a href="/blog/2012/03/">March 2012</a></li><li><a href="/blog/2012/02/">February 2012</a></li><li><a href="/blog/2012/01/">January 2012</a></li></ul><h3>2011</h3><ul><li><a href="/blog/2011/10/">October 2011</a></li><li><a href="/blog/2011/09/">September 2011</a></li><li><a href="/blog/2011/08/">August 2011</a></li><li><a href="/blog/2011/07/">July 2011</a></li><li><a href="/blog/2011/06/">June 2011</a></li><li><a href="/blog/2011/05/">May 2011</a></li><li><a href="/blog/2011/04/">April 2011</a></li><li><a href="/blog/2011/03/">March 2011</a></li><li><a href="/blog/2011/02/">February 2011</a></li><li><a href="/blog/2011/01/">January 2011</a></li></ul><h3>2010</h3><ul><li><a href="/blog/2010/12/">December 2010</a></li><li><a href="/blog/2010/11/">November 2010</a></li><li><a href="/blog/2010/10/">October 2010</a></li><li><a href="/blog/2010/09/">September 2010</a></li><li><a href="/blog/2010/08/">August 2010</a></li><li><a href="/blog/2010/07/">July 2010</a></li><li><a href="/blog/2010/06/">June 2010</a></li><li><a href="/blog/2010/05/">May 2010</a></li><li><a href="/blog/2010/04/">April 2010</a></li><li><a href="/blog/2010/03/">March 2010</a></li><li><a href="/blog/2010/02/">February 2010</a></li><li><a href="/blog/2010/01/">January 2010</a></li></ul><h3>2009</h3><ul><li><a href="/blog/2009/12/">December 2009</a></li><li><a href="/blog/2009/11/">November 2009</a></li><li><a href="/blog/2009/10/">October 2009</a></li><li><a href="/blog/2009/09/">September 2009</a></li><li><a href="/blog/2009/08/">August 2009</a></li><li><a href="/blog/2009/07/">July 2009</a></li><li><a href="/blog/2009/06/">June 2009</a></li><li><a href="/blog/2009/05/">May 2009</a></li><li><a href="/blog/2009/04/">April 2009</a></li><li><a href="/blog/2009/03/">March 2009</a></li><li><a href="/blog/2009/02/">February 2009</a></li><li><a href="/blog/2009/01/">January 2009</a></li></ul><h3>2008</h3><ul><li><a href="/blog/2008/11/">November 2008</a></li><li><a href="/blog/2008/10/">October 2008</a></li><li><a href="/blog/2008/09/">September 2008</a></li><li><a href="/blog/2008/08/">August 2008</a></li></ul></div></aside></article></div></div></div><footer><div class="outer-wrap"><div class="wrap"><div id="copyright"><img alt="Agora Games" src="/assets/images/agora-logo-agga-5548a56c.png"> <a href="http://majorleaguegaming.com" target="_blank"><img alt="Major League Gaming" src="/assets/images/mlg-logo-70241e5b.png"></a><a href="mailto:info@agoragames.com" id="email-us">Email Us</a><p>359 Broadway, Third Floor, Troy, NY 12180</p><p class="dim">&copy; 2013 Agora Games. All Rights Reserved.</p></div></div></div></footer><div class="hide"><iframe id="wufoo-iframe" src="javascript:void(0)"></iframe><a id="wufoo-thanks" href="/thanks/"></a></div><!--[if lt IE 9]>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<![endif]-->
<!--[if gte IE 9]><!-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<!--<![endif]-->
<script>
  if (!window.jQuery) {
    document.write('<script type="text/javascript" src="/assets/javascripts/vendor/jquery.min-199fc76d.js"><' + '/script>');
  }
</script>
<script src="/assets/javascripts/all-2f5d049e.js" type="text/javascript"></script></body></html>