<!DOCTYPE html> <html class=no-js lang=en> <head> <meta charset=utf-8> <meta content='width=device-width, initial-scale=1.0' name=viewport> <meta content='IE=edge,chrome=1' http-equiv=X-UA-Compatible> <title>Brain Matters</title> <link href="/assets/stylesheets/app-3b1b68ac.css" rel=stylesheet /> <script src="/assets/javascripts/modernizr-84a49412.js"></script> <link href='/assets/images/wb-square-e5e8663b.png' rel=icon sizes=128x128 type='image/png'> </head> <body class='blog blog_2010 blog_2010_07 blog_2010_07_index f-topbar-fixed'> <div class='fixed raised'> <nav class=top-bar data-topbar role=navigation> <ul class=title-area> <li class=name> <h1> <a href='/'> <img alt=Agora class="wb-agora main-logo" src="/assets/images/wb-agora-d26616f7.svg"/> </a> </h1> </li> <li class='toggle-topbar menu-icon'> <a href='javascript:void(0)'> <span>Menu</span> </a> </li> </ul> <section class=top-bar-section> <ul class=right> <li> <a data-anchor href='/#about'>About</a> </li> <li> <a data-anchor href='/#team'>Team</a> </li> <li> <a href='/careers'>Careers</a> </li> <li> <a data-anchor href='/#contact'>Contact</a> </li> <li class=hydra-theme> <a href='http://hydra.agoragames.com'> <img alt=Hydra width=92 src="/assets/images/hydra-wordmark-6248cf07.svg"/> </a> </li> </ul> </section> </nav> </div> <div class=row> <div class=columns> <h1 class=blog-page-title> <a href="/blog">The <strong>Blog</strong> </a></h1> </div> </div> <div class=row> <div class='columns large-9'> <div class=blog-page-subtitle> <h2>Posts from July 2010 </h2> </div> <div class=blog-entry-list><div class=blog-entry> <div class=blog__date> Jul 29 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/07/29/party-for-misha/">Party for Misha</a> </h2> <div class=blog__author> By <strong>David Czarnecki</strong> </div> <div class=blog__body> <p><img alt=image width=500 height=375 src="/assets/images/uploads/2010/07/wpid-1280422338861-c8d1d87f.jpg"/></p> <p>Today is Misha&rsquo;s last day.Â  We wished him luck and toasted him off with some local microbrews from the Troy Pub and Brewery.</p> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Jul 29 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/07/29/brightercove/">Brightercove</a> </h2> <div class=blog__author> By <strong>David Czarnecki</strong> </div> <div class=blog__body> <p>We&rsquo;re using <a href="http://www.brightcove.com/en/">Brightcove</a> here at Agora Games for some video platform work. In our group chats, we&rsquo;ve talked about, &ldquo;It would be nice if we had a Ruby API for interacting with Brightcove.&rdquo;</p> <p>And so I did just that, <a href="http://github.com/agoragames/brightcove">http://github.com/agoragames/brightcove</a></p> <pre class="highlight ruby"><code><span class="n">sudo</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">brightcove</span><span class="o">-</span><span class="n">api</span>

<span class="o">&gt;&gt;</span> <span class="nb">require</span> <span class="s1">'brightcove-api'</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;&gt;</span> <span class="n">brightcove</span> <span class="o">=</span> <span class="no">Brightcove</span><span class="o">::</span><span class="no">API</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'0Z2dtxTdJAxtbZ-d0U7Bhio2V1Rhr5Iafl5FFtDPY8E.'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#</span>
<span class="o">&gt;&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">brightcove</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'find_all_videos'</span><span class="p">,</span> <span class="p">{</span><span class="ss">:page_size</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">:video_fields</span> <span class="o">=&gt;</span> <span class="s1">'id,name,linkURL,linkText'</span><span class="p">})</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="s2">"items"</span><span class="o">=&gt;</span><span class="p">[{</span><span class="s2">"name"</span><span class="o">=&gt;</span><span class="s2">"Documentarian Skydiving"</span><span class="p">,</span> <span class="s2">"id"</span><span class="o">=&gt;</span><span class="mi">496518762</span><span class="p">,</span> <span class="s2">"linkText"</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">"linkURL"</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">},</span> <span class="p">{</span><span class="s2">"name"</span><span class="o">=&gt;</span><span class="s2">"Surface Tricks"</span><span class="p">,</span> <span class="s2">"id"</span><span class="o">=&gt;</span><span class="mi">496518763</span><span class="p">,</span> <span class="s2">"linkText"</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">"linkURL"</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">},</span> <span class="p">{</span><span class="s2">"name"</span><span class="o">=&gt;</span><span class="s2">"Free Skiing"</span><span class="p">,</span> <span class="s2">"id"</span><span class="o">=&gt;</span><span class="mi">496518765</span><span class="p">,</span> <span class="s2">"linkText"</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">"linkURL"</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">}],</span> <span class="s2">"page_number"</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">"page_size"</span><span class="o">=&gt;</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"total_count"</span><span class="o">=&gt;-</span><span class="mi">1</span><span class="p">}</span>
</code></pre> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Jul 28 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/07/28/grabbing-the-rabbit-by-the-horns/">Grabbing the Rabbit by the Horns</a> </h2> <div class=blog__author> By <strong>Aaron Westendorf</strong> </div> <div class=blog__body> <p>RabbitMQ is a very powerful tool, especially when deployed in a cluster. Among RabbitMQ&rsquo;s more useful features is rabbitmqctl, the command line tool which can be used to query a node and list its exchanges, queues, connections, number of consumers, memory usage and more.</p> <p>The application, and cluster deployment in general, is hamstrung by Erlang&rsquo;s standard approach to cookies. The cookie, typically .erlang.cookie in the HOME directory of an application, must have only user read permissions. For a Linux RabbitMQ install, that would look like this:</p> <pre class="highlight plaintext"><code>bofh@rabbit_host1:~$ ls -al /var/lib/rabbitmq/
total 333
drwxr-xr-x 3 rabbitmq rabbitmq 160 2010-07-12 17:49 .
drwxr-xr-x 37 root root 1008 2010-07-02 14:29 ..
-r-------- 1 rabbitmq rabbitmq 20 2010-05-04 20:44 .erlang.cookie
drwxr-xr-x 3 rabbitmq rabbitmq 72 2010-05-04 20:49 mnesia
-rw-r--r-- 1 rabbitmq rabbitmq 27 2010-07-12 17:49 pids
</code></pre> <p>Any variation on these permissions and Erlang will refuse to start. The permissions requirement is embedded into Erlang itself, making it more or less impossible to work around. This creates the following problems:</p> <ul> <li>You must copy this file (or its contents) to all hosts in the cluster</li> <li>All users of rabbitmqctl must run it as sudo</li> <li>All monitoring tools must also run as root or have sudo capability</li> <li>You must have the cookie file present on the host running rabbitmqctl</li> </ul> <p>Given how powerful rabbitmqctl is, you will likely still want to limit access to it, but this can be readily accomplished with standard Unix permissions. By expanding who can use it and where, your system administrator will be thrilled to reduce need for sudo access and your customers will be happy with the additional tools you can deploy to monitor your cluster and its clients to ensure that all is well, 24/7.</p> <p>Thankfully, RabbitMQ&rsquo;s scripts accept a lot of environment variables which can be passed into the Erlang runtime, and Erlang kindly provides a way to bypass the cookie file through a command line literal. The scripts are all located in the scripts directory inside your RabbitMQ installation.</p> <pre class="highlight plaintext"><code>bofh@rabbit_host:~$ ls -ald `erl -eval 'io:format("~s~n", [code:lib_dir()])' -s init stop -noshell`/rabbitmq-server\*/scripts
drwxr-xr-x 2 root root 520 2010-07-21 14:47 /usr/local/lib/erlang/lib/rabbitmq-server-1.7.0/scripts
drwxr-xr-x 2 root root 520 2010-07-21 16:15 /usr/local/lib/erlang/lib/rabbitmq-server-1.7.2/scripts
</code></pre> <p>The three standard scripts, rabbitmq-server, rabbitmq-multi and rabbitmqctl all source an environment script, rabbitmq-env, which in turn will source the file /etc/rabbitmq/rabbitmq.conf if it exists. This is the file that you can edit to take control of your RabbitMQ cluster.</p> <pre class="highlight plaintext"><code>SERVER_START_ARGS="+K true +A300 +P512000 -setcookie NOMNOMNOMYUMYUM -kernel inet_default_listen_options [{nodelay,true},{sndbuf,32768},{recbuf,32768}]"
MULTI_START_ARGS="-setcookie NOMNOMNOMYUMYUM"
CTL_ERL_ARGS="-setcookie NOMNOMNOMYUMYUM"
</code></pre> <p>The value of each environment variable will be passed verbatim to the Erlang runtime. The <code>SERVER_START_ARGS</code> are passed to each node started by rabbitmq-multi, and directly affect the performance of a RabbitMQ instance. In this example, we have increased the number of native threads available to Erlang and allowed it to spin up numerous (Erlang) processes. We have also instructed the kernel to increase its TCP buffer sizes and disable Nagle&rsquo;s algorithm.</p> <p>You can now run rabbitmqctl without sudo on any host which has this same configuration deployed. This solution still requires that you synchronize /etc/rabbitmq across your cluster, though there are many ways of solving that problem.</p> <p>We have taken this a step further and enabled rabbitmqctl on any host in our network. All of our core software is deployed from source to /usr/local over NFS. We have deployed the rabbitmq.conf file there too, and have a small shell script wrapping rabbitmqctl.</p> <pre class="highlight shell"><code><span class="c">#!/bin/bash</span>
<span class="nv">ERL_PATH</span><span class="o">=</span><span class="sb">`</span>erl -eval <span class="s1">'io:format("~s~n", [code:lib_dir()])'</span> -s init stop -noshell<span class="sb">`</span>
<span class="nv">LATEST_VERSION</span><span class="o">=</span><span class="sb">`</span>ls <span class="nv">$ERL_PATH</span> | grep rabbitmq | sort | tail -1<span class="sb">`</span>
<span class="nv">RABBIT_PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$ERL_PATH</span><span class="s2">/</span><span class="nv">$LATEST_VERSION</span><span class="s2">"</span>

<span class="nb">set</span> -f
<span class="o">[</span> -f /usr/local/etc/rabbitmq/rabbitmq.conf <span class="o">]</span> <span class="o">&amp;&amp;</span> . /usr/local/etc/rabbitmq/rabbitmq.conf
<span class="nb">export </span>CTL_ERL_ARGS
<span class="nv">HOME</span><span class="o">=</span>/var/lib/rabbitmq <span class="nv">$RABBIT_PATH</span>/scripts/rabbitmqctl <span class="nv">$@</span>
</code></pre> <p>We can now connect to and monitor any RabbitMQ node from any host on our network</p> <pre class="highlight plaintext"><code>bofh@gateway:~$ rabbitmqctl -n rabbit@rabbit_host1 status
Status of node rabbit@rabbit_host1 ...
[{running_applications,[{rabbit,"RabbitMQ","1.7.2"},
{mnesia,"MNESIA CXC 138 12","4.4.10"},
{os_mon,"CPO CXC 138 46","2.2.2"},
{sasl,"SASL CXC 138 11","2.1.6"},
{stdlib,"ERTS CXC 138 10","1.16.2"},
{kernel,"ERTS CXC 138 10","2.13.2"}]},
{nodes,[rabbit@rabbit_host1,rabbit@rabbit_host2]},
{running_nodes,[rabbit@rabbit_host1,rabbit@rabbit_host2]}]
...done.
</code></pre> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Jul 27 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2010/07/27/rails-3-0-0-rc-changes/">Rails 3.0.0.rc changes</a> </h2> <div class=blog__author> By <strong>David Czarnecki</strong> </div> <div class=blog__body> <p>Rails 3.0.0 now has a <a href="http://weblog.rubyonrails.org/2010/7/26/rails-3-0-release-candidate">release candidate</a>. These are the changes I made to a new application I am working on to clear up any deprecation warnings.</p> <p><strong>Gemfile</strong></p> <p>gem &lsquo;rails&rsquo;, &lsquo;3.0.0.rc&rsquo; gem &lsquo;haml&rsquo;, &lsquo;3.0.14&rsquo;</p> <p>Obviously you have to tell your application to use the 3.0.0.rc. Also, it seems as if haml 3.0.13, which we were previously using, had some incompatible changes with Rails 3.0.0.rc</p> <p><strong>Rakefile</strong></p> <p>Change:</p> <p>Rails::Application.load_tasks</p> <p>to:</p> <p>YourApplicationName::Application.load_tasks</p> <p><strong>config/environments/test.rb</strong></p> <p>Add:</p> <p>config.active_support.deprecation = :stderr</p> <p><strong>config/routes.rb</strong></p> <p>Change:</p> <p>YourApplicationName::Application.routes.draw do |map|</p> <p>to:</p> <p>YourApplicationName::Application.routes.draw do</p> <p>Rails 3 routing in great detail: <a href="http://www.engineyard.com/blog/2010/the-lowdown-on-routes-in-rails-3/">The Lowdown on Routes in Rails 3</a>.</p> </div> </div> </div> </div> </div> <div class='columns large-3'> <div class=blog-archives-sidebar> <h2>Blog archives</h2> <h3> <a href="/blog/2015/">2015</a> </h3> <ul> <li> <a href="/blog/2015/10/">October 2015</a> </li> <li> <a href="/blog/2015/03/">March 2015</a> </li> <li> <a href="/blog/2015/01/">January 2015</a> </li> </ul> <h3> <a href="/blog/2014/">2014</a> </h3> <ul> <li> <a href="/blog/2014/12/">December 2014</a> </li> <li> <a href="/blog/2014/11/">November 2014</a> </li> <li> <a href="/blog/2014/10/">October 2014</a> </li> <li> <a href="/blog/2014/08/">August 2014</a> </li> <li> <a href="/blog/2014/07/">July 2014</a> </li> <li> <a href="/blog/2014/06/">June 2014</a> </li> <li> <a href="/blog/2014/04/">April 2014</a> </li> <li> <a href="/blog/2014/03/">March 2014</a> </li> <li> <a href="/blog/2014/02/">February 2014</a> </li> <li> <a href="/blog/2014/01/">January 2014</a> </li> </ul> <h3> <a href="/blog/2013/">2013</a> </h3> <ul> <li> <a href="/blog/2013/11/">November 2013</a> </li> <li> <a href="/blog/2013/10/">October 2013</a> </li> <li> <a href="/blog/2013/09/">September 2013</a> </li> <li> <a href="/blog/2013/08/">August 2013</a> </li> <li> <a href="/blog/2013/07/">July 2013</a> </li> <li> <a href="/blog/2013/06/">June 2013</a> </li> <li> <a href="/blog/2013/05/">May 2013</a> </li> <li> <a href="/blog/2013/04/">April 2013</a> </li> <li> <a href="/blog/2013/03/">March 2013</a> </li> <li> <a href="/blog/2013/02/">February 2013</a> </li> <li> <a href="/blog/2013/01/">January 2013</a> </li> </ul> <h3> <a href="/blog/2012/">2012</a> </h3> <ul> <li> <a href="/blog/2012/12/">December 2012</a> </li> <li> <a href="/blog/2012/11/">November 2012</a> </li> <li> <a href="/blog/2012/10/">October 2012</a> </li> <li> <a href="/blog/2012/09/">September 2012</a> </li> <li> <a href="/blog/2012/08/">August 2012</a> </li> <li> <a href="/blog/2012/07/">July 2012</a> </li> <li> <a href="/blog/2012/06/">June 2012</a> </li> <li> <a href="/blog/2012/05/">May 2012</a> </li> <li> <a href="/blog/2012/04/">April 2012</a> </li> <li> <a href="/blog/2012/03/">March 2012</a> </li> <li> <a href="/blog/2012/02/">February 2012</a> </li> <li> <a href="/blog/2012/01/">January 2012</a> </li> </ul> <h3> <a href="/blog/2011/">2011</a> </h3> <ul> <li> <a href="/blog/2011/10/">October 2011</a> </li> <li> <a href="/blog/2011/09/">September 2011</a> </li> <li> <a href="/blog/2011/08/">August 2011</a> </li> <li> <a href="/blog/2011/07/">July 2011</a> </li> <li> <a href="/blog/2011/06/">June 2011</a> </li> <li> <a href="/blog/2011/05/">May 2011</a> </li> <li> <a href="/blog/2011/04/">April 2011</a> </li> <li> <a href="/blog/2011/03/">March 2011</a> </li> <li> <a href="/blog/2011/02/">February 2011</a> </li> <li> <a href="/blog/2011/01/">January 2011</a> </li> </ul> <h3> <a href="/blog/2010/">2010</a> </h3> <ul> <li> <a href="/blog/2010/12/">December 2010</a> </li> <li> <a href="/blog/2010/11/">November 2010</a> </li> <li> <a href="/blog/2010/10/">October 2010</a> </li> <li> <a href="/blog/2010/09/">September 2010</a> </li> <li> <a href="/blog/2010/08/">August 2010</a> </li> <li> <a href="/blog/2010/07/">July 2010</a> </li> <li> <a href="/blog/2010/06/">June 2010</a> </li> <li> <a href="/blog/2010/05/">May 2010</a> </li> <li> <a href="/blog/2010/04/">April 2010</a> </li> <li> <a href="/blog/2010/03/">March 2010</a> </li> <li> <a href="/blog/2010/02/">February 2010</a> </li> <li> <a href="/blog/2010/01/">January 2010</a> </li> </ul> <h3> <a href="/blog/2009/">2009</a> </h3> <ul> <li> <a href="/blog/2009/12/">December 2009</a> </li> <li> <a href="/blog/2009/11/">November 2009</a> </li> <li> <a href="/blog/2009/10/">October 2009</a> </li> <li> <a href="/blog/2009/09/">September 2009</a> </li> <li> <a href="/blog/2009/08/">August 2009</a> </li> <li> <a href="/blog/2009/07/">July 2009</a> </li> <li> <a href="/blog/2009/06/">June 2009</a> </li> <li> <a href="/blog/2009/05/">May 2009</a> </li> <li> <a href="/blog/2009/04/">April 2009</a> </li> <li> <a href="/blog/2009/03/">March 2009</a> </li> <li> <a href="/blog/2009/02/">February 2009</a> </li> <li> <a href="/blog/2009/01/">January 2009</a> </li> </ul> <h3> <a href="/blog/2008/">2008</a> </h3> <ul> <li> <a href="/blog/2008/11/">November 2008</a> </li> <li> <a href="/blog/2008/10/">October 2008</a> </li> <li> <a href="/blog/2008/09/">September 2008</a> </li> <li> <a href="/blog/2008/08/">August 2008</a> </li> </ul> </div> </div> </div> <script src="/assets/javascripts/app-8d34dc05.js" async=true></script> </body> </html>