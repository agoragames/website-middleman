<!DOCTYPE html> <html class=no-js lang=en> <head> <meta charset=utf-8> <meta content='width=device-width, initial-scale=1.0' name=viewport> <meta content='IE=edge,chrome=1' http-equiv=X-UA-Compatible> <title>Brain Matters</title> <link href="/assets/stylesheets/app-d7ac800e.css" rel=stylesheet /> <script src="/assets/javascripts/modernizr-84a49412.js"></script> <link href='/assets/images/favicon.ico' rel='shortcut icon'> </head> <body class='blog blog_2009 blog_2009_10 blog_2009_10_index f-topbar-fixed'> <div class='fixed raised'> <nav class=top-bar data-topbar role=navigation> <ul class=title-area> <li class=name> <h1> <a href='/'> <img alt="Agora Games" class=main-logo src="/assets/images/agoragames-new-8534f601.svg"/> </a> </h1> </li> <li class='toggle-topbar menu-icon'> <a href='javascript:void(0)'> <span>Menu</span> </a> </li> </ul> <section class=top-bar-section> <ul class=right> <li> <a data-anchor href='/#about'>About</a> </li> <li> <a data-anchor href='/#team'>Team</a> </li> <li> <a data-anchor href='/#contact'>Contact</a> </li> <li> <a href='/blog'>Blog</a> </li> <li class=hydra-theme> <a href='http://hydra.agoragames.com'> <img alt=Hydra width=92 src="/assets/images/hydra-wordmark-6248cf07.svg"/> </a> </li> </ul> </section> </nav> </div> <div class=row> <div class=columns> <h1 class=blog-page-title> <a href="/blog">The <strong>Blog</strong> </a></h1> </div> </div> <div class=row> <div class='columns large-9'> <div class=blog-page-subtitle> <h2>Posts from October 2009 </h2> </div> <div class=blog-entry-list><div class=blog-entry> <div class=blog__date> Oct 12 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2009/10/12/spelunking-into-your-logs-with-splunk/">Spelunking into your logs with Splunk</a> </h2> <div class=blog__author> By <strong>Tim Jones</strong> </div> <div class=blog__body> <p>At Agora we're experimenting with Splunk as a error collection and reporting tool.  The idea is that all our services will spit out error information to syslog which will be picked up and indexed by Splunk.  Splunk will be configured to display info about recent errors, email summaries of those errors and generally be the starting point for discovering problems with our systems.  In our previous infrastructure error collection and reporting was handled on a per-project basis.  As we're now moving to a more service oriented approach that involves a small number of generic but highly configurable services deployed over a large number nodes we needed something different.  Splunk seems ideal for this.  It accepts a number of different data sources ranging from syslog to raw log files to inputs from random UDP and TCP ports so we can easily integrate with systems we've written and, more importantly, those we haven't.  It also has the summary and reporting capabilities we were looking for so we can chart errors over time periods, dig for trends and see which services are acting up.</p> <p>The biggest problem I've had so far while working with Splunk is the documenation.  There are a lot of options and the documentation for those options is spread out over a number of distinct manuals.  Some options are poorly documented or not at all and often it's not clear, even once you've found the proper option, where/how the option should be used.  The following is an attempt to lay out some of those problems I ran into and what the solutions are so you don't have to go looking yourself.  This list will likely continue to grow over the coming weeks and months.</p> <ol> <li><strong>Extracting fields from search results</strong></li> </ol> <p>Splunk automatically extracts certain fields from your search results.  This is all well and good but what if you want to pull out your own values?  As an example we stick a field into our syslog output that indicates what service the log entry came from.  This would be extremely handy since we'd then be able to filter out entries for a particular services, build charts with color coding based around the services and so on.  It turns out this is pretty easy.  Although this functionality is mentioned in the 'User Manual' most of the ral documentation for the commands used can be found in the 'Search Manual' (grrrr).  The portion in the User Manual can be found by search for 'Extract fields with search commands'.  For the command information look for 'rex' in the 'Search Commands' section of the Search Reference.Anywho, the trick is in the 'rex' command.  This can be chained onto your search request (something else that was not obvious) like many other Splunk commands:</p> <p>  sourcetype="syslog" foo | rex field=_raw "[0-9a-z]{2} err [(?<service>.\*?)\]"  </service></p> <p>The rex command takes a regular expression and produces fields based on matches.  The field option specifies which of Splunk's default fields you want to match against (search in the Splunk manuals for 'Use default and internal fields' for a list of all available fields).  The regex in this case matches two alphanumeric characters followed by the string 'err' followed by a service name in brackets.  The ?<service> notation in parentheses indicates a match that should be saved in the 'service' field.</service></p> <p>Once your search has been executed you should see that you can now filter on whatever fields you extracted, create charts with them, etc. 2. <strong>Extracting only those results that have a particular field</strong></p> <p>So you've created a regex to extract certain fields from your result set but the results that don't match your regex are still in the result set.  How do you filter those out?  The solution is actually pretty simple:</p> <pre><code>&lt;your_original_search&gt; | rex &lt;your regex&gt; | search your_field="\*"
</code></pre> <p>Likewise you can find those that didn't match by negating the lookup:</p> <pre><code>&lt;your_original_search&gt; | rex &lt;your regex&gt; | search NOT your_field="*"
</code></pre> <ol> <li><strong>Changing indices for search</strong></li> </ol> <p>By default your searches will only hit the 'main' index.  If you've created your own index it won't be searched by default.  To use your index in a particular search just add it to the search string:</p> <pre><code>index=my_index foo NOT bar
</code></pre> <p>To add your index to the default list so you don't have to modify every search you'll need to modify your roles a bit.  Visit the Roles page in the Manager, select your role (probably user or admin if you haven't made any modifications here, and scroll down to the 'Default indexes' list. 4. <strong>Displaying the body of a message in an event table</strong></p> <p>In our main dashboard we wanted to show a list of the 5 most recent errors.  This actually turned out to be more difficult than you might have expected.  The date, host, and a few other pieces of data showed up fine but for the life of me I couldn't figure out how to get the body of the log message to show up in the table.  There is a special field called _raw for each result but adding that to the table had no effect.  In the end my solution was to create a regexp against my search results that extracted a parameter called 'body'.</p> <p>Search:</p> <pre><code>sourcetype="syslog" err | rex field=_raw "[0-9a-z]{2} err \[(?&lt;service&gt;.*?)\] (?&lt;body&gt;.*)"
</code></pre> <p>Event Table:</p> <pre><code>&lt;table&gt;
&lt;title&gt;Most recent service errors&lt;/title&gt;
&lt;searchName&gt;Service errors with body&lt;/searchName&gt;
&lt;option name="count"&gt;5&lt;/option&gt;
&lt;fields&gt;_time,host,body&lt;/fields&gt;
&lt;/table&gt;
</code></pre> <p>The events table:</p> <p><img alt=events width=801 height=247 src="/assets/images/uploads/2009/10/events-d43cf79e.png"/></p> <ol> <li><strong>Changing the default app</strong></li> </ol> <p>With a normal install the launcher is the default app.  This gets kind of annoying after a while.  To change it to your own app you can adjust the default_namespace option in $SPLUNK_HOME/etc/apps/user-prefs/local/user-prefx.conf.</p> <pre><code>default_namespace = my_app
</code></pre> <ol> <li><strong>Email alerts</strong></li> </ol> <p>Email alerts are built around scheduled searches.  When saving or editing a search you're given the option to provide a schedule for it.  Change this option so that the search is run on some interval and additional options will appear including one to send an email alert.  Additionally you can modify the search to only include a certain time range.  These features are very handy when used in combination.  Schedule your search to run every 30 minutes and adjust the start time to -30m and you'll get alerts about all errors that occurred during that time.</p> <p>Mail settings themselves can be found in Manager -&gt; Email alert settings. 7. <strong>Stacked time-based charts</strong></p> <p>Took me a while to sort out this one.  The first thing you need to do is group your data into larger time periods.  If you have one column for each second your graph is going to be pretty useless.  Instead you should consolidate your data into large groups such as one per minute or one per hour.  I've found that dividing your time range by roughly 30 gives the best graphs.  To actually perform this grouping you need to add the 'span' option to your search:</p> <pre><code>sourcetype="syslog" foo NOT bar | timechart span=1h count
</code></pre> <p>This will produce a count of all the items containing foo and not bar for syslog in intervals of one hour.</p> <p>Next you need to stack the resulting groups.  Annoyingly this is done at the view layer.  In my case I was adding it to my dashboard.  The relevant lines looked similar to the following:</p> <pre><code>&lt;chart&gt;
&lt;searchName&gt;Service errors in the last 24 hours&lt;/searchName&gt;
&lt;title&gt;Service errors in the last 24 hours&lt;/title&gt;
&lt;option name="charting.chart"&gt;column&lt;/option&gt;
&lt;option name="charting.chart.stackMode"&gt;stacked&lt;/option&gt;
&lt;/chart&gt;
</code></pre> <p>There is a reference for all these options in the Splunk docs.  Search for 'Custom charting configurations'.</p> <p>The end result looks something like this:</p> <p><img alt=errors width=804 height=245 src="/assets/images/uploads/2009/10/errors-99369b2b.png"/></p> <ol> <li><strong>Edit everything manually</strong></li> </ol> <p>The Splunk Manager interface is rather clunky (not entirely the developer's fault, there are a lot of interdependent options) so after a while you'll likely get sick of it.  That's perfectly fine.  All the options are written out to config files per app.  All your changes are written out to $SPLUNK_HOME/etc/apps/<your_app>/local and override those options in $SPLUNK_HOME/etc/apps/<your_app>/default.  The default directory can be used as a handy reference for available options as well.  Note that some system wide options such as indices and roles are written out to $SPLUNK_HOME/etc/system/local. 9. **Don't delete the 'user' role**</your_app></your_app></p> <p>If you do you'll be sad as it breaks everything.  I'd attempted to remove the role and replace it with our own modified version.  The result was that every page I visited gave me a "Client not authorized" error.  To resolve the problem delete the 'disabled = 1' line from $SPLUNK_HOME/etc/system/local/authorize.conf. 10. <strong>Adding output to syslog(-ng)</strong></p> <p>As mentioned previously our Splunk setup is largely based on syslog but because we want to have raw syslog files in addition to having them indexed by Splunk we allow syslog to write the logs to disk and then have Splunk watch the created files.  Some information such as facility and log level get lost during this process with most default syslog configurations.  To resolve this we did a little bit of reconfiguring to our syslog installs.First, it's important to note that we actually use syslog-ng rather than vanilla syslog.  Syslog-ng has some handy options for templating output as of 1.5.3.  For each destination you can specify a template function:</p> <pre><code>destination df_syslog { file("/var/log/syslog" template("$FULLDATE $FULLHOST $TAG $LEVEL $MESSAGE\n") template_escape(no)); };
</code></pre> <p>FULLDATE includes the year in the timestamp.  FULLHOST provides the hostname.  TAG is a hex encoding of the facility and level.  $LEVEL is a text representation of the level.  $MESSAGE is obviously just the message.  The template_escape(no) directive says that quotes should not be escaped.  Also note the newline at the end of the template.  Without it your output will be rather unreadable.</p> <p>And for reference the default appears to be similar to:</p> <pre><code>"$DATE $FULLHOST $MESSAGE\n" template_escape(no)
</code></pre> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Oct 7 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2009/10/07/integrating-lighthouse-and-instant-messenger-in-ruby/">Integrating Lighthouse and Instant Messenger in Ruby</a> </h2> <div class=blog__author> By <strong>David Czarnecki</strong> </div> <div class=blog__body> <p>The <a href="http://lighthouseapp.com/api/introduction">Introduction to the Lighthouse API</a> mentions something you might do with the Lighthouse API is "Accessing and creating tickets through your Instant Messenger client.". How easy is it to do this? Surprisingly easy.</p> <p>You will need to download and install the <a href="http://github.com/Caged/lighthouse-api">Lighthouse API</a> gem and the <a href="http://net-toc.rubyforge.org/doc/classes/Net/TOC.html">Net::TOC</a> gem.</p> <p>Run this in an irb session.</p> <p>```ruby</p> <p>require 'net/toc' require 'lighthouse' require 'sanitize' include Lighthouse</p> <p>Lighthouse.account = 'shaft' Lighthouse.token = 'hesonebadmotherfushutyourmouth'</p> <p>Net::TOC.new("someaimaccount", "someaimpassword") do |msg, buddy| project = Project.find(Sanitize.clean(msg).to_i) buddy.send_im("Here is some information about your project: #{project.name}") end</p> <p>```</p> <p>You should then be able to add 'someaimaccount' to your AIM buddy list and send a project ID and have it return the project name.</p> <p>And boom goes the dynamite!</p> <p>You'll of course need to change the Lighthouse account and token as appropriate (or use username and password for logging in). msg is a little weird and although it's a string, it's HTML, so you need to strip out any tags before doing anything. And of course you'd want to add in some way of parsing the input from the user into some DSL (Domain Specific Language) for interacting with your fancy new Lighthouse AIM bot.</p> <p>Happy hacking!</p> </div> </div> </div> <div class=blog-entry> <div class=blog__date> Oct 1 </div> <div class=blog__contents> <h2 class=blog__title> <a href="/blog/2009/10/01/mocking-http-request-and-response-with-python-and-mox/">Mocking HTTP request and response with Python and Mox</a> </h2> <div class=blog__author> By <strong>Aaron Westendorf</strong> </div> <div class=blog__body> <p>I recently started integrating with some web services in Python and wanted to be able to test all the requests and responses with valid and invalid data. However, I need to be able to do this without actually hitting the web service when testing. And of course I don't want to change my web service code to conditionally do things if running in a test environment. Enter mocking and Mox.</p> <p>One of our engineers, Tim, has written an excellent post on his adventures as a Ruby programmer getting up to speed on <a href="http://blog.agoragames.com/2009/02/23/python-is-mocking-me-a-ruby-programmers-adventures-with-pythonmox/">testing and mocking in Python using Mox</a>. You should read it.</p> <p>Back to my issue with mocking the HTTP request and response.</p> <p>Here is what I came up with. I first created a MockResponse class that adds a read() method to the string class.</p> <p>```python</p> <p>class MockResponse(str): ''' Mock response class with a method called read which will be used similar to the response from an HTTP request to a URL ''' def read(self): return self ```</p> <p>And here is a test in which I mock out the request and response for the urllib2.OpenerDirector.open method. I don't so much care what the request string is passed to the open call, so I use IgnoreArg(). And I return the XML that would be returned by the actual web service to indicate the username and/or password were incorrect.</p> <p>```python def test_logging_in_to_network_with_bad_username_and_password(self): my_network_service = MyNetworkService('foo', 'bar') self.mock(urllib2.OpenerDirector, 'open') urllib2.OpenerDirector.open(mox.IgnoreArg()).AndReturn(MockResponse('''30000ACCT_LOGIN_FAILED7''')) self.replay_all()</p> <pre><code>self.assertEqual(False, my_network_service.login())
self.mox.UnsetStubs()
self.mox.VerifyAll() ```
</code></pre> <p>If there's a better way, I'd love to hear your suggestions.</p> </div> </div> </div> </div> </div> <div class='columns large-3'> <div class=blog-archives-sidebar> <h2>Blog archives</h2> <h3> <a href="/blog/2015/">2015</a> </h3> <ul> <li> <a href="/blog/2015/03/">March 2015</a> </li> <li> <a href="/blog/2015/01/">January 2015</a> </li> </ul> <h3> <a href="/blog/2014/">2014</a> </h3> <ul> <li> <a href="/blog/2014/12/">December 2014</a> </li> <li> <a href="/blog/2014/11/">November 2014</a> </li> <li> <a href="/blog/2014/10/">October 2014</a> </li> <li> <a href="/blog/2014/08/">August 2014</a> </li> <li> <a href="/blog/2014/07/">July 2014</a> </li> <li> <a href="/blog/2014/06/">June 2014</a> </li> <li> <a href="/blog/2014/04/">April 2014</a> </li> <li> <a href="/blog/2014/03/">March 2014</a> </li> <li> <a href="/blog/2014/02/">February 2014</a> </li> <li> <a href="/blog/2014/01/">January 2014</a> </li> </ul> <h3> <a href="/blog/2013/">2013</a> </h3> <ul> <li> <a href="/blog/2013/11/">November 2013</a> </li> <li> <a href="/blog/2013/10/">October 2013</a> </li> <li> <a href="/blog/2013/09/">September 2013</a> </li> <li> <a href="/blog/2013/08/">August 2013</a> </li> <li> <a href="/blog/2013/07/">July 2013</a> </li> <li> <a href="/blog/2013/06/">June 2013</a> </li> <li> <a href="/blog/2013/05/">May 2013</a> </li> <li> <a href="/blog/2013/04/">April 2013</a> </li> <li> <a href="/blog/2013/03/">March 2013</a> </li> <li> <a href="/blog/2013/02/">February 2013</a> </li> <li> <a href="/blog/2013/01/">January 2013</a> </li> </ul> <h3> <a href="/blog/2012/">2012</a> </h3> <ul> <li> <a href="/blog/2012/12/">December 2012</a> </li> <li> <a href="/blog/2012/11/">November 2012</a> </li> <li> <a href="/blog/2012/10/">October 2012</a> </li> <li> <a href="/blog/2012/09/">September 2012</a> </li> <li> <a href="/blog/2012/08/">August 2012</a> </li> <li> <a href="/blog/2012/07/">July 2012</a> </li> <li> <a href="/blog/2012/06/">June 2012</a> </li> <li> <a href="/blog/2012/05/">May 2012</a> </li> <li> <a href="/blog/2012/04/">April 2012</a> </li> <li> <a href="/blog/2012/03/">March 2012</a> </li> <li> <a href="/blog/2012/02/">February 2012</a> </li> <li> <a href="/blog/2012/01/">January 2012</a> </li> </ul> <h3> <a href="/blog/2011/">2011</a> </h3> <ul> <li> <a href="/blog/2011/10/">October 2011</a> </li> <li> <a href="/blog/2011/09/">September 2011</a> </li> <li> <a href="/blog/2011/08/">August 2011</a> </li> <li> <a href="/blog/2011/07/">July 2011</a> </li> <li> <a href="/blog/2011/06/">June 2011</a> </li> <li> <a href="/blog/2011/05/">May 2011</a> </li> <li> <a href="/blog/2011/04/">April 2011</a> </li> <li> <a href="/blog/2011/03/">March 2011</a> </li> <li> <a href="/blog/2011/02/">February 2011</a> </li> <li> <a href="/blog/2011/01/">January 2011</a> </li> </ul> <h3> <a href="/blog/2010/">2010</a> </h3> <ul> <li> <a href="/blog/2010/12/">December 2010</a> </li> <li> <a href="/blog/2010/11/">November 2010</a> </li> <li> <a href="/blog/2010/10/">October 2010</a> </li> <li> <a href="/blog/2010/09/">September 2010</a> </li> <li> <a href="/blog/2010/08/">August 2010</a> </li> <li> <a href="/blog/2010/07/">July 2010</a> </li> <li> <a href="/blog/2010/06/">June 2010</a> </li> <li> <a href="/blog/2010/05/">May 2010</a> </li> <li> <a href="/blog/2010/04/">April 2010</a> </li> <li> <a href="/blog/2010/03/">March 2010</a> </li> <li> <a href="/blog/2010/02/">February 2010</a> </li> <li> <a href="/blog/2010/01/">January 2010</a> </li> </ul> <h3> <a href="/blog/2009/">2009</a> </h3> <ul> <li> <a href="/blog/2009/12/">December 2009</a> </li> <li> <a href="/blog/2009/11/">November 2009</a> </li> <li> <a href="/blog/2009/10/">October 2009</a> </li> <li> <a href="/blog/2009/09/">September 2009</a> </li> <li> <a href="/blog/2009/08/">August 2009</a> </li> <li> <a href="/blog/2009/07/">July 2009</a> </li> <li> <a href="/blog/2009/06/">June 2009</a> </li> <li> <a href="/blog/2009/05/">May 2009</a> </li> <li> <a href="/blog/2009/04/">April 2009</a> </li> <li> <a href="/blog/2009/03/">March 2009</a> </li> <li> <a href="/blog/2009/02/">February 2009</a> </li> <li> <a href="/blog/2009/01/">January 2009</a> </li> </ul> <h3> <a href="/blog/2008/">2008</a> </h3> <ul> <li> <a href="/blog/2008/11/">November 2008</a> </li> <li> <a href="/blog/2008/10/">October 2008</a> </li> <li> <a href="/blog/2008/09/">September 2008</a> </li> <li> <a href="/blog/2008/08/">August 2008</a> </li> </ul> </div> </div> </div> <script src="/assets/javascripts/app-8ee17240.js" async=true></script> </body> </html>