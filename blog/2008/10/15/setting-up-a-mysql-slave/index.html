<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><meta content="width=device-width" name="viewport"><title>Setting up a MySQL Slave</title><link href="/assets/images/favicon.ico" rel="shortcut icon"><link href="/assets/stylesheets/all-f38fbbc7.css" media="all" rel="stylesheet" type="text/css" /><!--[if lt IE 9]><script src="/assets/javascripts/vendor/html5shiv-8b3747c5.js" type="text/javascript"></script><![endif]--></head><body><div class="outer-wrap"><div class="inner-wrap"><div class="wrap"><header class="clearfix" id="page"><a href="/"><img alt="Agora Games" id="logo" src="/assets/images/agora-games-logo-be83adf8.png"></a><nav><ul><li><a href="https://hydra.agoragames.com/">Products</a></li><li><a href="/portfolio/">Customers</a></li><li><a href="/us/">Team</a></li><li><a href="/community/">Community</a></li><li><a href="/work-at-agora/">Jobs</a></li><li><a href="/blog/">Blog</a></li></ul></nav></header></div><div class="wrap"><article class="clearfix"><header><h1>The <strong>Blog</strong></h1></header><section id="blog-entry"><div class="blog-entry"><div class="date-comments"><div class="date">Oct 15</div></div><div class="blog-content"><h2>Setting up a MySQL Slave</h2><div class="blog-author">By <strong>Jason LaPorte</strong></div><div class="blog-body"><p>Sometimes, things go wrong.</p>

<p>Sometimes, things go horribly, horribly wrong, and there's nothing you can do to stop the slow-motion train wreck unfolding before your very eyes. (Like that one senior prom where you spilled your dinner all over your date's dress. On the upside, you didn't need that $200 anyway.) When things go that awry, there's no way to fix it. (She never did return your phone calls, did she?) The only thing you can do with a mistake like that is to make sure it never, ever happens again.</p>

<p>For most of the sites we produce, we use MySQL as a backend. While it's extremely rare for the MySQL server to catastrophically fail, it happens, and the more MySQL servers you have, the more likely it is to happen at least once. To keep this from causing problems for us, we replicate our databases (that is, maintain a live copy of them). This provides us with two benefits:</p>

<ol>
  <li>If the MySQL master (primary database) blows up, melts down, or gets eaten by vermin, we can "promote" the slave database (the clone) to fulfill the master's role while we figure out what happened and how to fix it, keeping the site up and preventing any data from being lost.</li>
  <li>Since the MySQL slave isn't used for anything other than covering our backsides, we can take it offline periodically to archive all the data in the database without impacting anything. (This is important when your site has literally four million users pouring statistics into it all day, every day, and doing a live backup <strong>will</strong> slow things down.) Archives are good in case you want to do statistical analysis on your data or in case you accidentally delete everything in the database after working a twelve hour day trying to figure out how vermin ate your master database. (Both of these have happened before. Sort of.)</li>
</ol>

<p>So, let me walk you through setting up a database slave from scratch.</p>

<p>I am starting with two identical machines that are running identical instances of MySQL. The first of these, Dragon, is going to be the master. The second of these, Unicorn, is going to be the slave. (So I name my servers after mythical beasts. What's wrong with that?) I am assuming a reasonable level of knowledge with the UNIX shell. If you lack familiarity, you really should spend some time learning. It will make you a better programmer, system administrator, friend, spouse, and human being.</p>

<p><strong>1.</strong> First, you should have the following items set in your MySQL configuration (/etc/mysql/my.cnf). If you don't, add them: they can go anywhere under the [mysqld] heading.</p>

<p><code>bash
 server-id = 1
 log-bin = /var/lib/mysql/binlog/mysql-bin
 expire_logs_days = 1
 max_binlog_size = 100M
 relay_log = /var/lib/mysql/binlog/mysqld-relay-bin
 relay_log_index = /var/lib/mysql/binlog/mysqld-relay-bin.index
</code></p>

<p>The server-id should be some unique number, not shared with any other machine on your network. Replication occurs by copying around binary log files; you should set expire_logs_days so that you don't end up with a huge pileup of data clogging up your disk drives (as they will eventually eat up your hard disk). We set binary logs to expire after 1 day, since our disks have a tendency to fill up on us quickly (for example, one of our Guitar Hero master databases has a 6GB binary log directory, even though it expires data after a single day!) Be advised that if you are worried about your slaves falling more than a day behind, you should keep logs around for a greater duration. (However, from our experience, if your slaves fall more than a day behind, you have bigger problems.) Finally, you can put datadir, relay_log, and relay_log_index wherever you please; above are just where we use. (Make sure, however, that they exist and are writable by the mysql user!)</p>

<p>You should restart the server after changing the settings. On Debian and Ubuntu, you can do this via "/etc/init.d/mysql restart".</p>

<p><strong>2.</strong> Your slave should have the same options defined as above in its MySQL configuration. The server-id option, however, <strong>must</strong> be different from the master (in our case, setting it to "2" will do). All the other options can be whatever you please.</p>

<p>Also restart this server when it's set as you like.</p>

<p><strong>3.</strong> You should grant permission for the slave to read data from the master. This can be done from the MySQL console on the master (mysql -h dragon -u root). Assuming the user name "foo" and the password "bar":</p>

<p><code>bash
 mysql&gt; GRANT REPLICATION SLAVE ON \*.\* TO 'foo'@'unicorn' IDENTIFIED BY 'bar';
</code></p>

<p>You can, of course, restrict which databases and tables you grant permissions with. We don't in this particular case.</p>

<p><strong>4.</strong> You now need to dump all of the data on the master, copy it over to the slave, and import it there; this is necessary even if your databases are empty, as it will initialize the slave regardless.</p>

<p>On the master (this will require your MySQL root password):</p>

<p><code>bash
 mysqldump -uroot -p --all-databases --single-transaction --master-data=1 | gzip &gt;master.sql.gz
</code></p>

<p>If you don't have a root password (which is generally a bad idea, but fine if your MySQL server is on a private network), you should omit the <code>-p</code> above.</p>

<p>You can copy this file over to the slave server using <code>scp</code>:</p>

<p><code>bash
 scp master.sql.gz unicorn:
</code></p>

<p>Finally, import the dump on the slave:</p>

<p><code>bash
 zcat master.sql.gz | mysql -uroot
</code></p>

<p><strong>5.</strong> Tell the slave to mirror the master.</p>

<p><code>bash
 mysql&gt; CHANGE MASTER TO MASTER_HOST='dragon', MASTER_USER='foo', MASTER_PASSWORD='bar';
</code></p>

<p><strong>6.</strong> Start the slave!</p>

<p><code>bash
 mysql&gt; START SLAVE;
</code>
 You can now monitor the progress of your slave using <code>SHOW SLAVE STATUS</code>. (If you use a <code>\G</code> instead of a semicolon to terminate the line, it will print out the data in a much more readable format.)</p>

<p><code>bash
 mysql&gt; SHOW SLAVE STATUS\G
</code></p>

<p>There could be a number of errors, which are beyond the scope of fixing here. (In my case, we ran into issues with binary logs and the binary log index files.) These can generally be troubleshooted (troubleshot?) by reading the output of syslog (<code>tail -f /var/log/syslog</code>) and fixing the problem one piece at a time; it helps to have a lot of UNIX experience, though.) If all goes well, though, <code>SHOW SLAVE STATUS</code> will have lines something like the following:</p>

<p><code>
Slave_IO_State: Waiting for master to send event
    Master_Host: dragon
           Master_Port: 3306
      Slave_IO_Running: Yes
    Slave_SQL_Running: Yes
 Seconds_Behind_Master: 12887
</code></p>

<p>This indicates that the slave is running and in the process of catching up to the master, and in time will be synchronized with it.</p>

<p>And, that's (hopefully!) all there is to it! Now, with your new slave, you can go forth and conquer the world! (Or, less ambitiously, cover your backside when you accidentally delete something.)</p>

<p><em>Obligatory CTO Note: Make sure you keep, and regularly verify your daily backups too!</em></p>
</div></div></div></section><aside id="sidebar"><div class="block" id="block-archive"><h2>Blog archives</h2><h3>2014</h3><ul><li><a href="/blog/2014/08/">August 2014</a></li><li><a href="/blog/2014/07/">July 2014</a></li><li><a href="/blog/2014/06/">June 2014</a></li><li><a href="/blog/2014/04/">April 2014</a></li><li><a href="/blog/2014/03/">March 2014</a></li><li><a href="/blog/2014/02/">February 2014</a></li><li><a href="/blog/2014/01/">January 2014</a></li></ul><h3>2013</h3><ul><li><a href="/blog/2013/11/">November 2013</a></li><li><a href="/blog/2013/10/">October 2013</a></li><li><a href="/blog/2013/09/">September 2013</a></li><li><a href="/blog/2013/08/">August 2013</a></li><li><a href="/blog/2013/07/">July 2013</a></li><li><a href="/blog/2013/06/">June 2013</a></li><li><a href="/blog/2013/05/">May 2013</a></li><li><a href="/blog/2013/04/">April 2013</a></li><li><a href="/blog/2013/03/">March 2013</a></li><li><a href="/blog/2013/02/">February 2013</a></li><li><a href="/blog/2013/01/">January 2013</a></li></ul><h3>2012</h3><ul><li><a href="/blog/2012/12/">December 2012</a></li><li><a href="/blog/2012/11/">November 2012</a></li><li><a href="/blog/2012/10/">October 2012</a></li><li><a href="/blog/2012/09/">September 2012</a></li><li><a href="/blog/2012/08/">August 2012</a></li><li><a href="/blog/2012/07/">July 2012</a></li><li><a href="/blog/2012/06/">June 2012</a></li><li><a href="/blog/2012/05/">May 2012</a></li><li><a href="/blog/2012/04/">April 2012</a></li><li><a href="/blog/2012/03/">March 2012</a></li><li><a href="/blog/2012/02/">February 2012</a></li><li><a href="/blog/2012/01/">January 2012</a></li></ul><h3>2011</h3><ul><li><a href="/blog/2011/10/">October 2011</a></li><li><a href="/blog/2011/09/">September 2011</a></li><li><a href="/blog/2011/08/">August 2011</a></li><li><a href="/blog/2011/07/">July 2011</a></li><li><a href="/blog/2011/06/">June 2011</a></li><li><a href="/blog/2011/05/">May 2011</a></li><li><a href="/blog/2011/04/">April 2011</a></li><li><a href="/blog/2011/03/">March 2011</a></li><li><a href="/blog/2011/02/">February 2011</a></li><li><a href="/blog/2011/01/">January 2011</a></li></ul><h3>2010</h3><ul><li><a href="/blog/2010/12/">December 2010</a></li><li><a href="/blog/2010/11/">November 2010</a></li><li><a href="/blog/2010/10/">October 2010</a></li><li><a href="/blog/2010/09/">September 2010</a></li><li><a href="/blog/2010/08/">August 2010</a></li><li><a href="/blog/2010/07/">July 2010</a></li><li><a href="/blog/2010/06/">June 2010</a></li><li><a href="/blog/2010/05/">May 2010</a></li><li><a href="/blog/2010/04/">April 2010</a></li><li><a href="/blog/2010/03/">March 2010</a></li><li><a href="/blog/2010/02/">February 2010</a></li><li><a href="/blog/2010/01/">January 2010</a></li></ul><h3>2009</h3><ul><li><a href="/blog/2009/12/">December 2009</a></li><li><a href="/blog/2009/11/">November 2009</a></li><li><a href="/blog/2009/10/">October 2009</a></li><li><a href="/blog/2009/09/">September 2009</a></li><li><a href="/blog/2009/08/">August 2009</a></li><li><a href="/blog/2009/07/">July 2009</a></li><li><a href="/blog/2009/06/">June 2009</a></li><li><a href="/blog/2009/05/">May 2009</a></li><li><a href="/blog/2009/04/">April 2009</a></li><li><a href="/blog/2009/03/">March 2009</a></li><li><a href="/blog/2009/02/">February 2009</a></li><li><a href="/blog/2009/01/">January 2009</a></li></ul><h3>2008</h3><ul><li><a href="/blog/2008/11/">November 2008</a></li><li><a href="/blog/2008/10/">October 2008</a></li><li><a href="/blog/2008/09/">September 2008</a></li><li><a href="/blog/2008/08/">August 2008</a></li></ul></div></aside></article></div></div></div><footer><div class="outer-wrap"><div class="wrap"><div id="copyright"><img alt="Agora Games" src="/assets/images/agora-logo-agga-5548a56c.png"> <a href="http://majorleaguegaming.com/" target="_blank"><img alt="Major League Gaming" src="/assets/images/mlg-logo-white-86eb4b68.png"></a><a href="mailto:info@agoragames.com" id="email-us">Email Us</a><p>359 Broadway, Third Floor, Troy, NY 12180</p><p class="dim">&copy; 2013 Agora Games. All Rights Reserved.</p></div></div></div></footer><div class="hide"><iframe id="wufoo-iframe" src="javascript:void(0)"></iframe><a id="wufoo-thanks" href="/thanks/"></a></div><!--[if lt IE 9]>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<![endif]-->
<!--[if gte IE 9]><!-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<!--<![endif]-->
<script>
  if (!window.jQuery) {
    document.write('<script type="text/javascript" src="/assets/javascripts/vendor/jquery.min-199fc76d.js"><' + '/script>');
  }
</script>
<script src="/assets/javascripts/all-2f5d049e.js" type="text/javascript"></script></body></html>